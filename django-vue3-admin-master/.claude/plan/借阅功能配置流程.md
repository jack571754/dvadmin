# 图书借阅功能 - 配置流程

> 创建时间：2026-01-27
> 适用版本：django-vue3-admin

---

## 📋 配置前准备

### 确认后端服务运行

```bash
# 进入后端目录
cd backend

# 启动后端服务（推荐使用 uvicorn）
uvicorn application.asgi:application --host 0.0.0.0 --port 9000 --reload
```

**验证方式：** 访问 http://localhost:9000/api/book/book/ 应该返回图书列表

### 确认前端服务运行

```bash
# 进入前端目录
cd web

# 启动前端服务
yarn run dev
```

**验证方式：** 访问 http://localhost:8080 应该显示登录页面

### 登录系统

- 用户名：`superadmin`
- 密码：`admin123456`

---

## 🔧 配置步骤

### 步骤 1：添加借阅记录菜单

#### 1.1 进入菜单管理

1. 登录系统后，点击左侧菜单 **系统管理**
2. 点击 **菜单管理**
3. 点击右上角 **新增** 按钮

#### 1.2 配置菜单信息

**基本信息：**

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **菜单类型** | 目录 | 选择"目录" |
| **菜单名称** | 借阅记录 | 显示的菜单名称 |
| **菜单排序** | 2 | 在图书管理下的排序 |
| **路由地址** | /book/borrow | 前端路由地址 |
| **组件路径** | book/borrow/index | 对应的 Vue 组件路径 |
| **是否外链** | 否 | |
| **是否缓存** | 是 | 缓存页面提升体验 |
| **是否可见** | 是 | 菜单是否显示 |
| **状态** | 启用 | |

**图标配置（可选）：**
- 点击图标选择器
- 选择一个合适的图标，如：Reading（阅读图标）

**保存菜单：**
- 点击 **确定** 按钮

---

### 步骤 2：配置借阅记录权限

#### 2.1 添加列表权限

在刚创建的"借阅记录"菜单下添加子权限：

1. 找到"借阅记录"菜单，点击其右侧的 **新增** 按钮
2. 配置子权限：

**基本信息：**

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **菜单类型** | 按钮 | 选择"按钮" |
| **菜单名称** | 查询 | 按钮名称 |
| **权限标识** | book:borrow:list | 权限代码 |
| **排序** | 1 | |
| **是否可见** | 否 | 按钮类型通常不可见 |

#### 2.2 添加其他权限

重复上述步骤，添加以下权限：

| 菜单名称 | 权限标识 | 排序 | 说明 |
|----------|----------|------|------|
| 新增 | book:borrow:Add | 2 | 添加借阅记录 |
| 编辑 | book:borrow:Update | 3 | 编辑借阅记录 |
| 删除 | book:borrow:Delete | 4 | 删除借阅记录 |
| 续借 | book:borrow:Renew | 5 | 续借操作 |

---

### 步骤 3：配置图书列表操作权限

需要为图书列表添加借阅和归还按钮的权限。

#### 3.1 找到图书管理菜单

1. 在菜单管理中，找到 **图书管理** -> **图书列表**
2. 点击 **图书列表** 右侧的 **新增** 按钮

#### 3.2 添加借阅按钮权限

| 配置项 | 值 |
|--------|-----|
| **菜单类型** | 按钮 |
| **菜单名称** | 借阅 |
| **权限标识** | book:book:Borrow |
| **排序** | 10 |
| **是否可见** | 否 |

#### 3.3 添加归还按钮权限

继续添加：

| 配置项 | 值 |
|--------|-----|
| **菜单类型** | 按钮 |
| **菜单名称** | 归还 |
| **权限标识** | book:book:Return |
| **排序** | 11 |
| **是否可见** | 否 |

---

### 步骤 4：分配角色权限

#### 4.1 进入角色管理

1. 点击左侧菜单 **系统管理** -> **角色管理**
2. 找到需要授权的角色（如：普通管理员），点击 **编辑**

#### 4.2 配置菜单权限

在弹出的对话框中：

1. 切换到 **菜单权限** 标签页
2. 勾选以下权限：
   - ✅ **图书管理**（整个模块）
     - ✅ 图书列表（所有权限）
     - ✅ **借阅记录**（新添加的）
       - ✅ 查询
       - ✅ 新增
       - ✅ 编辑
       - ✅ 删除
       - ✅ 续借
3. 点击 **确定** 保存

---

### 步骤 5：刷新并验证

#### 5.1 刷新前端页面

1. 退出登录或刷新浏览器（Ctrl + F5 强制刷新）
2. 重新登录系统
3. 在左侧菜单应该能看到 **图书管理** -> **借阅记录**

#### 5.2 验证功能

##### 测试借阅记录列表

1. 点击 **借阅记录** 菜单
2. 应该看到借阅记录列表页面
3. 表头应该包含：图书名称、ISBN、借阅用户、状态、借阅时间、应还时间等列
4. 右侧应该有搜索框（按用户名搜索）

##### 测试图书列表操作

1. 点击 **图书列表** 菜单
2. 找到一本库存大于0的图书
3. 操作列应该显示 **借阅** 按钮
4. 点击 **借阅** 按钮，应该提示"借阅成功"

---

## 🧪 功能测试流程

### 测试场景 1：借阅图书

**前置条件：**
- 已登录系统
- 有图书库存 > 0
- 用户有 `book:book:Borrow` 权限

**测试步骤：**

1. 进入 **图书列表**
2. 找到一本可借阅的图书（库存 > 0，状态 = 正常）
3. 点击操作列的 **借阅** 按钮
4. 应该显示"借阅成功"提示

**预期结果：**
- ✅ 提示"借阅成功"
- ✅ 图书的可借数量减 1
- ✅ 创建了一条借阅记录（状态=借阅中，应还日期=今天+30天）

**验证方式：**
1. 刷新图书列表，检查该图书的 `可借数量` 是否减少
2. 进入 **借阅记录** 列表，应该能看到新创建的借阅记录

---

### 测试场景 2：归还图书

**前置条件：**
- 已有借阅中的记录
- 用户有 `book:book:Return` 权限

**测试步骤：**

1. 进入 **图书列表**
2. 找到已借阅的图书
3. 点击操作列的 **归还** 按钮
4. 应该显示"归还成功"提示

**预期结果：**
- ✅ 提示"归还成功"
- ✅ 图书的可借数量加 1
- ✅ 借阅记录的状态更新为"已归还"
- ✅ 借阅记录的归还时间已填写

**验证方式：**
1. 刷新图书列表，检查该图书的 `可借数量` 是否增加
2. 进入 **借阅记录** 列表，该记录状态应为"已归还"

---

### 测试场景 3：续借操作

**前置条件：**
- 已有借阅中或已续借的记录
- 续借次数 < 最大续借次数
- 用户有 `book:borrow:Renew` 权限

**测试步骤：**

1. 进入 **借阅记录** 列表
2. 找到一条 `借阅中` 或 `已续借` 的记录
3. 检查续借次数是否 < 最大续借次数（默认3次）
4. 点击操作列的 **续借** 按钮
5. 应该显示"续借成功"提示

**预期结果：**
- ✅ 提示"续借成功"
- ✅ 应还日期延后 30 天
- ✅ 续借次数加 1
- ✅ 状态更新为"已续借"

**验证方式：**
1. 查看该记录的 `应还时间` 是否增加了30天
2. 查看 `续借次数` 是否增加了1
3. 查看 `状态` 是否变为"已续借"

---

### 测试场景 4：库存控制

**前置条件：**
- 有图书库存 = 0

**测试步骤：**

1. 进入 **图书列表**
2. 找到库存 = 0 的图书
3. **借阅** 按钮应该不显示（或显示为禁用）

**预期结果：**
- ✅ 库存为0时无法借阅

---

### 测试场景 5：续借次数限制

**前置条件：**
- 已有续借次数 = 3 的记录

**测试步骤：**

1. 进入 **借阅记录** 列表
2. 找到续借次数 = 3 的记录
3. **续借** 按钮应该不显示

**预期结果：**
- ✅ 达到最大续借次数时无法续借

---

### 测试场景 6：搜索和筛选

**测试步骤：**

1. 进入 **借阅记录** 列表
2. 在搜索框输入用户名（如：admin）
3. 点击搜索
4. 应该只显示该用户的借阅记录

**测试步骤（状态筛选）：**

1. 点击状态下拉框
2. 选择"借阅中"
3. 列表应该只显示状态为"借阅中"的记录

---

## 🐛 常见问题排查

### 问题 1：借阅记录菜单不显示

**可能原因：**
- 菜单未配置正确
- 路由地址错误
- 权限未分配
- 前端未刷新

**解决方法：**

1. 检查菜单配置：
   - 路由地址：`/book/borrow`
   - 组件路径：`book/borrow/index`
   - 父级菜单：图书管理

2. 检查文件是否存在：
   ```bash
   # 检查前端文件
   ls web/src/views/book/borrow/
   # 应该包含：api.ts, crud.tsx, index.vue, constants.ts
   ```

3. 强制刷新浏览器（Ctrl + F5）

4. 重新登录系统

---

### 问题 2：借阅按钮不显示

**可能原因：**
- 权限未配置
- 权限标识不匹配
- 角色未分配权限

**解决方法：**

1. 检查权限配置：
   - 权限标识：`book:book:Borrow`
   - 菜单类型：按钮
   - 已分配给角色

2. 检查前端代码：
   ```typescript
   // web/src/views/book/book/crud.tsx
   show: auth('book:book:Borrow')
   ```

3. 重新登录系统

---

### 问题 3：借阅失败，提示"用户未登录"

**可能原因：**
- JWT Token 过期
- 后端未正确获取用户信息

**解决方法：**

1. 重新登录系统
2. 检查浏览器控制台是否有错误
3. 检查后端日志

---

### 问题 4：归还失败，提示"未找到借阅记录"

**可能原因：**
- 当前用户没有借阅该图书
- 借阅记录已归还

**解决方法：**

1. 确认当前用户是否借阅了该图书
2. 进入 **借阅记录** 列表，检查是否有该图书的借阅中记录

---

### 问题 5：续借按钮不显示

**可能原因：**
- 权限未配置
- 已达到最大续借次数
- 状态不允许续借

**解决方法：**

1. 检查续借次数是否 < 3
2. 检查记录状态是否为"借阅中"或"已续借"
3. 检查权限配置：`book:borrow:Renew`

---

## 📊 权限清单速查

### 借阅记录模块

| 权限名称 | 权限标识 | 用途 |
|----------|----------|------|
| 查询 | book:borrow:list | 查看借阅记录列表 |
| 新增 | book:borrow:Add | 手动添加借阅记录 |
| 编辑 | book:borrow:Update | 编辑借阅记录 |
| 删除 | book:borrow:Delete | 删除借阅记录 |
| 续借 | book:borrow:Renew | 续借操作 |

### 图书列表模块

| 权限名称 | 权限标识 | 用途 |
|----------|----------|------|
| 借阅 | book:book:Borrow | 借阅图书 |
| 归还 | book:book:Return | 归还图书 |

---

## 🎯 配置完成检查清单

配置完成后，请逐项检查：

### 后端检查

- [ ] 后端服务正常运行（端口 9000）
- [ ] 数据库迁移已完成
- [ ] API 接口可访问（http://localhost:9000/api/book/）

### 前端检查

- [ ] 前端服务正常运行（端口 8080）
- [ ] 借阅记录菜单显示正常
- [ ] 页面组件加载正常
- [ ] 无控制台错误

### 功能检查

- [ ] 可以正常借阅图书
- [ ] 可以正常归还图书
- [ ] 可以正常续借
- [ ] 库存数量正确更新
- [ ] 搜索筛选功能正常

### 权限检查

- [ ] 无权限用户无法看到按钮
- [ ] 有权限用户可以正常操作

---

## 📝 配置完成后操作

### 1. 添加测试数据

可以使用脚本创建测试数据，或手动通过界面创建：

```python
# backend/create_test_borrow_data.py
from dvadmin.book.models import Book, BookBorrow
from django.contrib.auth import get_user_model
from django.utils import timezone
from datetime import timedelta

User = get_user_model()

# 获取测试用户
user = User.objects.first()
book = Book.objects.filter(available_quantity__gt=0).first()

# 创建测试借阅记录
borrow = BookBorrow.objects.create(
    book=book,
    user=user,
    status=0,  # 借阅中
    borrow_date=timezone.now(),
    due_date=timezone.now() + timedelta(days=30)
)

print(f"创建测试借阅记录：{borrow}")
```

### 2. 通知用户

配置完成后，通知相关用户：

1. 新增了"借阅管理"功能
2. 可以在图书列表直接借阅/归还
3. 可以查看借阅记录和历史

### 3. 监控运行

- 观察系统日志
- 收集用户反馈
- 及时处理问题

---

## 🎓 进阶配置（可选）

### 1. 配置定时任务

自动更新逾期状态：

```python
# backend/dvadmin/book/tasks.py
from celery import shared_task
from django.utils import timezone
from dvadmin.book.models import BookBorrow

@shared_task
def update_overdue_status():
    """更新逾期状态"""
    now = timezone.now()
    # 将借阅中且超过应还时间的记录标记为逾期
    BookBorrow.objects.filter(
        status=0,  # 借阅中
        due_date__lt=now  # 应还时间已过
    ).update(status=2)  # 逾期未还
```

### 2. 配置消息通知

归还提醒、逾期提醒等。

### 3. 配置数据权限

让普通用户只能看到自己的借阅记录。

---

**配置完成时间：** 约 15-20 分钟
**难度等级：** ⭐⭐☆☆☆

如有问题，请参考"常见问题排查"部分。
