# 图书管理页面修改删除功能 - 执行计划

> 任务描述：图书管理页面没有 修改和删除功能
> 创建时间：2026-01-27
> 计划状态：待审批

---

## 上下文信息

### 问题分析

**现象**：图书管理页面不显示修改和删除按钮

**根因**：
1. 前端代码已完整实现（`web/src/views/book/book/crud.tsx`）
2. 后端已支持完整的 CRUD 操作（`backend/dvadmin/book/views.py`）
3. **缺少数据库中的按钮权限记录**（`dvadmin_system_menu_button` 表）

**技术原理**：
- DVAdmin 权限控制通过菜单按钮（MenuButton）实现
- 前端使用 `auth('权限值')` 判断按钮显示
- 权限值需在数据库的 `menu_button` 表中存在
- 角色需要分配对应权限才能显示按钮

### 涉及文件

| 文件路径 | 操作类型 | 说明 |
|---------|----------|------|
| `backend/init_book_menu.py` | 修改 | 添加按钮权限配置函数 |
| `backend/dvadmin/system/models.py` | 参考 | MenuButton 模型结构 |
| `web/src/views/book/book/crud.tsx` | 参考 | 前端权限标识 |
| `web/src/views/book/book/api.ts` | 参考 | API 接口地址 |

---

## 执行步骤

### 步骤 1：修改 init_book_menu.py

**文件**：`backend/init_book_menu.py`

**操作**：添加按钮权限配置函数

**预期结果**：
- 新增 `create_menu_buttons()` 函数
- 新增 `init_button_permissions()` 函数
- 支持幂等执行（可重复运行）

**核心逻辑**：
```python
def create_menu_buttons(menu, button_list):
    """为菜单创建按钮权限"""
    for button_data in button_list:
        MenuButton.objects.get_or_create(
            menu=menu,
            value=button_data['value'],
            defaults=button_data
        )
```

---

### 步骤 2-5：为各菜单添加按钮权限

#### 按钮权限配置清单

**1. 图书列表菜单** (`/book/book`)
```python
buttons = [
    {'name': '查询', 'value': 'book:book:Search', 'api': '/api/book/book/', 'method': 0},
    {'name': '新增', 'value': 'book:book:add', 'api': '/api/book/book/', 'method': 1},
    {'name': '修改', 'value': 'book:book:Update', 'api': '/api/book/book/{id}/', 'method': 2},
    {'name': '删除', 'value': 'book:book:Delete', 'api': '/api/book/book/{id}/', 'method': 3},
]
```

**2. 图书分类菜单** (`/book/category`)
```python
buttons = [
    {'name': '查询', 'value': 'book:category:Search', 'api': '/api/book/category/', 'method': 0},
    {'name': '新增', 'value': 'book:category:add', 'api': '/api/book/category/', 'method': 1},
    {'name': '修改', 'value': 'book:category:Update', 'api': '/api/book/category/{id}/', 'method': 2},
    {'name': '删除', 'value': 'book:category:Delete', 'api': '/api/book/category/{id}/', 'method': 3},
]
```

**3. 图书作者菜单** (`/book/author`)
```python
buttons = [
    {'name': '查询', 'value': 'book:author:Search', 'api': '/api/book/author/', 'method': 0},
    {'name': '新增', 'value': 'book:author:add', 'api': '/api/book/author/', 'method': 1},
    {'name': '修改', 'value': 'book:author:Update', 'api': '/api/book/author/{id}/', 'method': 2},
    {'name': '删除', 'value': 'book:author:Delete', 'api': '/api/book/author/{id}/', 'method': 3},
]
```

**4. 图书出版社菜单** (`/book/publisher`)
```python
buttons = [
    {'name': '查询', 'value': 'book:publisher:Search', 'api': '/api/book/publisher/', 'method': 0},
    {'name': '新增', 'value': 'book:publisher:add', 'api': '/api/book/publisher/', 'method': 1},
    {'name': '修改', 'value': 'book:publisher:Update', 'api': '/api/book/publisher/{id}/', 'method': 2},
    {'name': '删除', 'value': 'book:publisher:Delete', 'api': '/api/book/publisher/{id}/', 'method': 3},
]
```

---

### 步骤 6：执行脚本

**命令**：
```bash
cd backend
python init_book_menu.py
```

**预期输出**：
```
=== Initializing Book Management Menus ===
Parent menu ID: X, created: True/False
  Submenu Book List: ID=X, created=True/False
  Submenu Categories: ID=X, created=True/False
  Submenu Authors: ID=X, created=True/False
  Submenu Publishers: ID=X, created=True/False
=== Initializing Button Permissions ===
  Book List buttons: 4 created/updated
  Category buttons: 4 created/updated
  Author buttons: 4 created/updated
  Publisher buttons: 4 created/updated
=== Done! ===
```

---

### 步骤 7：验证前端按钮

**操作**：
1. 刷新前端页面
2. 进入图书管理模块
3. 检查操作列是否显示"修改"和"删除"按钮
4. 测试按钮功能是否正常

**预期结果**：
- 操作列显示编辑和删除按钮
- 点击按钮可以正常打开对话框
- 提交后数据成功更新/删除

---

## 技术细节

### MenuButton 模型结构

```python
class MenuButton(CoreModel):
    menu = models.ForeignKey(to="Menu", ...)
    name = models.CharField(max_length=64, verbose_name="名称")
    value = models.CharField(unique=True, max_length=64, verbose_name="权限值")
    api = models.CharField(max_length=200, verbose_name="接口地址")
    METHOD_CHOICES = (
        (0, "GET"),
        (1, "POST"),
        (2, "PUT"),
        (3, "DELETE"),
    )
    method = models.IntegerField(default=0, verbose_name="接口请求方法")
```

### 前端权限判断

```typescript
// web/src/views/book/book/crud.tsx
edit: {
    show: auth('book:book:Update'),  // 需要数据库中有此权限值
},
remove: {
    show: auth('book:book:Delete'),  // 需要数据库中有此权限值
},
```

---

## 成功标准

1. ✅ 脚本执行无错误
2. ✅ 数据库 `dvadmin_system_menu_button` 表中包含 16 条按钮权限记录
3. ✅ 前端图书管理页面显示修改和删除按钮
4. ✅ 修改功能正常工作
5. ✅ 删除功能正常工作

---

## 回滚方案

如需回滚，执行以下 SQL：

```sql
DELETE FROM dvadmin_system_menu_button WHERE value LIKE 'book:%';
```

或使用 Django Shell：
```python
from dvadmin.system.models import MenuButton
MenuButton.objects.filter(value__startswith='book:').delete()
```

---

## 后续任务

- [ ] 为管理员角色分配图书管理权限
- [ ] 为其他角色按需分配权限
- [ ] 考虑是否需要为借阅记录、预约记录添加按钮权限
