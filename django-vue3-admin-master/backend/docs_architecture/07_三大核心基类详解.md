# DVAdmin ä¸‰å¤§æ ¸å¿ƒåŸºç±»è¯¦è§£

> ä½œè€…: Claude AI
> åˆ›å»ºæ—¶é—´: 2024-01-25
> é€‚ç”¨ç‰ˆæœ¬: DVAdmin 3.x
> éš¾åº¦çº§åˆ«: â­â­â­â­ (é«˜çº§)

---

## ğŸ“– æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£æ·±å…¥è§£æ DVAdmin æ¡†æ¶çš„ä¸‰å¤§æ ¸å¿ƒåŸºç±»ï¼š`CoreModel`ã€`CustomModelSerializer`ã€`CustomModelViewSet`ï¼Œä»¥åŠå®ƒä»¬å¦‚ä½•åä½œæ„å»ºå®Œæ•´çš„æ•°æ®å¤„ç†é“¾è·¯ã€‚

### å­¦ä¹ ç›®æ ‡

- âœ… ç†è§£ä¸‰å¤§æ ¸å¿ƒåŸºç±»çš„è®¾è®¡åŸç†
- âœ… æŒæ¡æ¯ä¸ªåŸºç±»æä¾›çš„åŠŸèƒ½
- âœ… ç†è§£ä¸‰è€…ä¹‹é—´çš„åä½œå…³ç³»
- âœ… å­¦ä¼šåœ¨å®é™…å¼€å‘ä¸­æ­£ç¡®ä½¿ç”¨è¿™äº›åŸºç±»

### å‰ç½®çŸ¥è¯†

- Django åŸºç¡€ï¼ˆæ¨¡å‹ã€åºåˆ—åŒ–å™¨ã€è§†å›¾ï¼‰
- Django REST Framework åŸºç¡€
- Python é¢å‘å¯¹è±¡ï¼ˆç»§æ‰¿ã€å¤šæ€ï¼‰

---

## ğŸ“‹ ç›®å½•

- [ä¸‰å¤§åŸºç±»æ€»è§ˆ](#ä¸‰å¤§åŸºç±»æ€»è§ˆ)
- [CoreModel - æ•°æ®æ¨¡å‹åŸºç±»](#coremodel---æ•°æ®æ¨¡å‹åŸºç±»)
- [CustomModelSerializer - åºåˆ—åŒ–å™¨åŸºç±»](#custommodelserializer---åºåˆ—åŒ–å™¨åŸºç±»)
- [CustomModelViewSet - è§†å›¾é›†åŸºç±»](#custommodelviewset---è§†å›¾é›†åŸºç±»)
- [ä¸‰è€…åä½œå…³ç³»](#ä¸‰è€…åä½œå…³ç³»)
- [å®Œæ•´ç¤ºä¾‹æ¼”ç¤º](#å®Œæ•´ç¤ºä¾‹æ¼”ç¤º)
- [è®¾è®¡æ¨¡å¼åˆ†æ](#è®¾è®¡æ¨¡å¼åˆ†æ)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ä¸‰å¤§åŸºç±»æ€»è§ˆ

### æ¶æ„å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  DVAdmin æ ¸å¿ƒæ¶æ„                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    CoreModel              CustomModelSerializer      CustomModelViewSet
   (æ•°æ®å±‚)                    (åºåˆ—åŒ–å±‚)                  (è§†å›¾å±‚)
        â”‚                            â”‚                          â”‚
        â”‚ ç»§æ‰¿                       â”‚ ç»§æ‰¿                     â”‚ ç»§æ‰¿
        â–¼                            â–¼                          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Book   â”‚              â”‚BookSerializerâ”‚          â”‚ BookViewSet â”‚
   â”‚(ä¸šåŠ¡æ¨¡å‹)â”‚              â”‚ (ä¸šåŠ¡åºåˆ—åŒ–å™¨) â”‚          â”‚ (ä¸šåŠ¡è§†å›¾é›†)  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### èŒè´£åˆ’åˆ†

| åŸºç±» | å±‚çº§ | èŒè´£ | æ ¸å¿ƒåŠŸèƒ½ |
|------|------|------|---------|
| **CoreModel** | æ•°æ®å±‚ | å®šä¹‰æ•°æ®ç»“æ„ | å®¡è®¡å­—æ®µã€è½¯åˆ é™¤ã€è¾…åŠ©æ–¹æ³• |
| **CustomModelSerializer** | åºåˆ—åŒ–å±‚ | æ•°æ®è½¬æ¢ä¸éªŒè¯ | è‡ªåŠ¨å¡«å……å®¡è®¡å­—æ®µã€æ ¼å¼åŒ–ã€é”™è¯¯å¤„ç† |
| **CustomModelViewSet** | è§†å›¾å±‚ | ä¸šåŠ¡é€»è¾‘å¤„ç† | CRUDã€æƒé™æ§åˆ¶ã€æ‰¹é‡æ“ä½œ |

### æ•°æ®æµè½¬

```
ç”¨æˆ·è¯·æ±‚
    â†“
CustomModelViewSet (ä¸šåŠ¡é€»è¾‘æ§åˆ¶)
    â†“ é€‰æ‹©
CustomModelSerializer (æ•°æ®å¤„ç†ä¸éªŒè¯)
    â†“ æ“ä½œ
CoreModel (æ•°æ®å­˜å‚¨)
    â†“
æ•°æ®åº“
```

---

## CoreModel - æ•°æ®æ¨¡å‹åŸºç±»

### æºç ä½ç½®

`backend/dvadmin/utils/models.py:104-232`

### æºç è§£æ

```python
class CoreModel(models.Model):
    """
    æ ¸å¿ƒæ ‡å‡†æŠ½è±¡æ¨¡å‹ï¼Œæ‰€æœ‰ä¸šåŠ¡æ¨¡å‹éƒ½åº”è¯¥ç»§æ‰¿å®ƒ
    å¢åŠ å®¡è®¡å­—æ®µï¼Œè¦†ç›–å­—æ®µæ—¶ï¼Œå­—æ®µåç§°è¯·å‹¿ä¿®æ”¹ï¼Œå¿…é¡»ç»Ÿä¸€å®¡è®¡å­—æ®µåç§°
    """
    # ä¸»é”®
    id = models.BigAutoField(primary_key=True, help_text="Id", verbose_name="Id")

    # æè¿°å­—æ®µ
    description = models.CharField(
        max_length=255,
        verbose_name="æè¿°",
        null=True,
        blank=True,
        help_text="æè¿°"
    )

    # å®¡è®¡å­—æ®µï¼ˆè‡ªåŠ¨è®°å½•ï¼‰
    creator = models.ForeignKey(
        to=settings.AUTH_USER_MODEL,
        related_query_name='creator_query',
        null=True,
        verbose_name='åˆ›å»ºäºº',
        help_text="åˆ›å»ºäºº",
        on_delete=models.SET_NULL,
        db_constraint=False
    )

    modifier = models.CharField(
        max_length=255,
        null=True,
        blank=True,
        help_text="ä¿®æ”¹äºº",
        verbose_name="ä¿®æ”¹äºº"
    )

    dept_belong_id = models.CharField(
        max_length=255,
        help_text="æ•°æ®å½’å±éƒ¨é—¨",
        null=True,
        blank=True,
        verbose_name="æ•°æ®å½’å±éƒ¨é—¨"
    )

    update_datetime = models.DateTimeField(
        auto_now=True,
        null=True,
        blank=True,
        help_text="ä¿®æ”¹æ—¶é—´",
        verbose_name="ä¿®æ”¹æ—¶é—´"
    )

    create_datetime = models.DateTimeField(
        auto_now_add=True,
        null=True,
        blank=True,
        help_text="åˆ›å»ºæ—¶é—´",
        verbose_name="åˆ›å»ºæ—¶é—´"
    )

    # è‡ªå®šä¹‰ç®¡ç†å™¨
    objects = CoreModelManager()
    all_objects = models.Manager()

    class Meta:
        abstract = True  # æŠ½è±¡æ¨¡å‹ï¼Œä¸ä¼šåˆ›å»ºæ•°æ®åº“è¡¨
        verbose_name = 'æ ¸å¿ƒæ¨¡å‹'
        verbose_name_plural = verbose_name

    # è¾…åŠ©æ–¹æ³•
    def get_request_user(self, request: Request):
        """è·å–è¯·æ±‚ç”¨æˆ·"""
        if getattr(request, "user", None):
            return request.user
        return None

    def get_request_user_id(self, request: Request):
        """è·å–è¯·æ±‚ç”¨æˆ·ID"""
        if getattr(request, "user", None):
            return getattr(request.user, "id", None)
        return None

    def common_insert_data(self, request: Request):
        """è·å–æ’å…¥æ—¶çš„å…¬å…±æ•°æ®"""
        data = {
            'create_datetime': datetime.now(),
            'creator': self.get_request_user(request)
        }
        return {**data, **self.common_update_data(request)}

    def common_update_data(self, request: Request):
        """è·å–æ›´æ–°æ—¶çš„å…¬å…±æ•°æ®"""
        return {
            'update_datetime': datetime.now(),
            'modifier': self.get_request_user_username(request)
        }

    # æ’é™¤å­—æ®µåˆ—è¡¨ï¼ˆä¸éœ€è¦å¯¼å‡ºçš„å­—æ®µï¼‰
    exclude_fields = [
        '_state', 'pk', 'id',
        'create_datetime', 'update_datetime',
        'creator', 'creator_id', 'creator_pk', 'creator_name',
        'modifier', 'modifier_id', 'modifier_pk', 'modifier_name',
        'dept_belong_id',
    ]
```

### æä¾›çš„åŠŸèƒ½

#### 1. å®¡è®¡å­—æ®µï¼ˆè‡ªåŠ¨è®°å½•ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | è‡ªåŠ¨å¡«å…… |
|------|------|------|---------|
| `id` | BigAutoField | ä¸»é”® | Django è‡ªåŠ¨ç”Ÿæˆ |
| `creator` | ForeignKey | åˆ›å»ºäºº | CustomModelSerializer å¡«å…… |
| `modifier` | CharField | ä¿®æ”¹äººID | CustomModelSerializer å¡«å…… |
| `dept_belong_id` | CharField | æ•°æ®å½’å±éƒ¨é—¨ | CustomModelSerializer å¡«å…… |
| `create_datetime` | DateTimeField | åˆ›å»ºæ—¶é—´ | Django auto_now_add |
| `update_datetime` | DateTimeField | æ›´æ–°æ—¶é—´ | Django auto_now |
| `description` | CharField | æè¿° | ç”¨æˆ·è¾“å…¥ |

#### 2. è‡ªå®šä¹‰ç®¡ç†å™¨

```python
class CoreModelManager(models.Manager):
    """æ ¸å¿ƒæ¨¡å‹ç®¡ç†å™¨"""

    def get_queryset(self):
        """é‡å†™æŸ¥è¯¢é›†ï¼Œè‡ªåŠ¨è¿‡æ»¤"""
        queryset = super().get_queryset()
        # è‡ªåŠ¨è¿‡æ»¤è½¯åˆ é™¤çš„æ•°æ®
        is_deleted = getattr(self.model, 'is_soft_delete', False)
        if is_deleted:
            queryset = queryset.filter(is_deleted=False)
        # è‡ªåŠ¨è¿‡æ»¤å·¥ä½œæµçŠ¶æ€
        flow_work_status = getattr(self.model, 'flow_work_status', False)
        if flow_work_status:
            queryset = queryset.filter(flow_work_status=1)
        return queryset

    def create(self, request=None, **kwargs):
        """é‡å†™ create æ–¹æ³•ï¼Œè‡ªåŠ¨å¡«å……å®¡è®¡å­—æ®µ"""
        data = {**kwargs}
        if request:
            request_user = request.user
            data["creator"] = request_user
            data["modifier"] = request_user.id
            data["dept_belong_id"] = request_user.dept_id
        return super().create(**data)
```

#### 3. è¾…åŠ©æ–¹æ³•

```python
# è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
def get_request_user(self, request)
def get_request_user_id(self, request)
def get_request_user_name(self, request)
def get_request_user_username(self, request)

# æ•°æ®è½¬æ¢
def to_data(self)              # è½¬æ¢ä¸ºå­—å…¸ï¼ˆæ’é™¤å®¡è®¡å­—æ®µï¼‰
def to_dict_data(self)         # è½¬æ¢ä¸ºå¯å¯¼å‡ºå­—å…¸

# æ•°æ®æ“ä½œ
def insert(self, request)      # æ’å…¥æ•°æ®ï¼ˆè‡ªåŠ¨å¡«å……å®¡è®¡å­—æ®µï¼‰
def update(self, request, update_data)  # æ›´æ–°æ•°æ®
```

### ä½¿ç”¨ç¤ºä¾‹

```python
from dvadmin.utils.models import CoreModel

class Book(CoreModel):
    """
    ç»§æ‰¿ CoreModel åï¼Œè‡ªåŠ¨è·å¾—ï¼š
    - id, creator, modifier, dept_belong_id
    - create_datetime, update_datetime
    """
    title = models.CharField(max_length=200, verbose_name="ä¹¦å")
    isbn = models.CharField(max_length=13, unique=True, verbose_name="ISBN")
    price = models.DecimalField(max_digits=10, decimal_places=2, verbose_name="ä»·æ ¼")
    stock = models.IntegerField(default=0, verbose_name="åº“å­˜")

    class Meta:
        db_table = 'dvadmin_book'
        verbose_name = 'å›¾ä¹¦'
        verbose_name_plural = verbose_name

# ä½¿ç”¨ç¤ºä¾‹
# æ–¹æ³•1ï¼šé€šè¿‡ç®¡ç†å™¨åˆ›å»ºï¼ˆæ¨èï¼‰
book = Book.objects.create(
    request=request,
    title="Pythonç¼–ç¨‹ä»å…¥é—¨åˆ°ç²¾é€š",
    isbn="9787111111111",
    price=89.00,
    stock=10
)
# è‡ªåŠ¨å¡«å……ï¼š
# book.creator = request.user
# book.modifier = str(request.user.id)
# book.dept_belong_id = request.user.dept_id
# book.create_datetime = datetime.now()
# book.update_datetime = datetime.now()

# æ–¹æ³•2ï¼šæ‰‹åŠ¨åˆ›å»ºåä¿å­˜
book = Book(
    title="Djangoå®æˆ˜",
    isbn="9787111111112",
    price=99.00,
    stock=5
)
book.insert(request)  # è‡ªåŠ¨å¡«å……å®¡è®¡å­—æ®µ

# æ–¹æ³•3ï¼šæ›´æ–°æ•°æ®
book.update(request, {'price': 79.00})
# è‡ªåŠ¨æ›´æ–°ï¼š
# book.modifier = str(request.user.id)
# book.update_datetime = datetime.now()
```

### æ•°æ®åº“è¡¨ç»“æ„

```sql
CREATE TABLE dvadmin_book (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL,
    isbn VARCHAR(13) UNIQUE NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    stock INT DEFAULT 0,
    description VARCHAR(255),
    creator_id BIGINT,                    -- å®¡è®¡å­—æ®µ
    modifier VARCHAR(255),                -- å®¡è®¡å­—æ®µ
    dept_belong_id VARCHAR(255),          -- å®¡è®¡å­—æ®µ
    create_datetime DATETIME,             -- å®¡è®¡å­—æ®µ
    update_datetime DATETIME,             -- å®¡è®¡å­—æ®µ
    INDEX idx_dept_belong_id (dept_belong_id)
);
```

### æ³¨æ„äº‹é¡¹

1. **å­—æ®µåç§°å›ºå®š** - å®¡è®¡å­—æ®µåç§°ä¸å¯ä¿®æ”¹ï¼Œå¦åˆ™ä¼šå½±å“åŠŸèƒ½
2. **abstract=True** - CoreModel æ˜¯æŠ½è±¡æ¨¡å‹ï¼Œä¸ä¼šåˆ›å»ºæ•°æ®åº“è¡¨
3. **å¤–é”®çº¦æŸ** - creator å¤–é”®è®¾ç½®äº† `db_constraint=False`ï¼Œä¸åœ¨æ•°æ®åº“å±‚é¢åˆ›å»ºå¤–é”®çº¦æŸ
4. **è½¯åˆ é™¤** - å¦‚æœéœ€è¦è½¯åˆ é™¤ï¼Œå¯ä»¥åœ¨æ¨¡å‹ä¸­æ·»åŠ  `is_soft_delete = True`

---

## CustomModelSerializer - åºåˆ—åŒ–å™¨åŸºç±»

### æºç ä½ç½®

`backend/dvadmin/utils/serializers.py:20-171`

### æºç è§£æ

```python
class CustomModelSerializer(DynamicFieldsMixin, ModelSerializer):
    """
    å¢å¼ºDRFçš„ModelSerializerï¼Œå¯è‡ªåŠ¨æ›´æ–°æ¨¡å‹çš„å®¡è®¡å­—æ®µè®°å½•
    (1) self.request èƒ½è·å–åˆ° rest_framework.request.Request å¯¹è±¡
    """

    # å®¡è®¡å­—æ®µåºåˆ—åŒ–é…ç½®
    modifier_field_id = "modifier"  # ä¿®æ”¹äººå­—æ®µå
    creator_field_id = "creator"    # åˆ›å»ºäººå­—æ®µå
    dept_belong_id_field_name = "dept_belong_id"  # éƒ¨é—¨å­—æ®µå

    # å®¡è®¡å­—æ®µåºåˆ—åŒ–å™¨
    modifier_name = serializers.SerializerMethodField(read_only=True)

    def get_modifier_name(self, instance):
        """è·å–ä¿®æ”¹äººå§“å"""
        if not hasattr(instance, "modifier"):
            return None
        queryset = (
            Users.objects.filter(id=instance.modifier)
            .values_list("name", flat=True)
            .first()
        )
        return queryset if queryset else None

    creator_name = serializers.SlugRelatedField(
        slug_field="name",
        source="creator",
        read_only=True
    )

    # æ—¶é—´å­—æ®µæ ¼å¼åŒ–
    create_datetime = serializers.DateTimeField(
        format="%Y-%m-%d %H:%M:%S",
        required=False,
        read_only=True
    )

    update_datetime = serializers.DateTimeField(
        format="%Y-%m-%d %H:%M:%S",
        required=False,
        read_only=True
    )

    def __init__(self, instance=None, data=empty, request=None, **kwargs):
        """åˆå§‹åŒ–æ—¶ä¿å­˜ request å¯¹è±¡"""
        super().__init__(instance, data, **kwargs)
        self.request = request or self.context.get("request", None)

    def create(self, validated_data):
        """
        é‡å†™ createï¼Œè‡ªåŠ¨å¡«å……å®¡è®¡å­—æ®µ
        """
        if self.request:
            if str(self.request.user) != "AnonymousUser":
                # è‡ªåŠ¨å¡«å……ä¿®æ”¹äºº
                if self.modifier_field_id in self.fields.fields:
                    validated_data[self.modifier_field_id] = self.get_request_user_id()
                # è‡ªåŠ¨å¡«å……åˆ›å»ºäºº
                if self.creator_field_id in self.fields.fields:
                    validated_data[self.creator_field_id] = self.request.user
                # è‡ªåŠ¨å¡«å……éƒ¨é—¨
                if (
                    self.dept_belong_id_field_name in self.fields.fields
                    and validated_data.get(self.dept_belong_id_field_name, None) is None
                ):
                    validated_data[self.dept_belong_id_field_name] = getattr(
                        self.request.user, "dept_id", validated_data.get(self.dept_belong_id_field_name, None)
                    )
        return super().create(validated_data)

    def update(self, instance, validated_data):
        """
        é‡å†™ updateï¼Œè‡ªåŠ¨æ›´æ–°ä¿®æ”¹äºº
        """
        if self.request:
            if str(self.request.user) != "AnonymousUser":
                if self.modifier_field_id in self.fields.fields:
                    validated_data[self.modifier_field_id] = self.get_request_user_id()
            if hasattr(self.instance, self.modifier_field_id):
                setattr(
                    self.instance, self.modifier_field_id, self.get_request_user_id()
                )
        return super().update(instance, validated_data)

    # è¾…åŠ©æ–¹æ³•
    def get_request_username(self):
        """è·å–å½“å‰ç”¨æˆ·å"""
        if getattr(self.request, "user", None):
            return getattr(self.request.user, "username", None)
        return None

    def get_request_name(self):
        """è·å–å½“å‰ç”¨æˆ·å§“å"""
        if getattr(self.request, "user", None):
            return getattr(self.request.user, "name", None)
        return None

    def get_request_user_id(self):
        """è·å–å½“å‰ç”¨æˆ·ID"""
        if getattr(self.request, "user", None):
            return getattr(self.request.user, "id", None)
        return None

    @property
    def errors(self):
        """
        é‡å†™ errors å±æ€§ï¼Œä½¿ç”¨å­—æ®µ verbose_name æ›¿æ¢å­—æ®µå
        ä½¿é”™è¯¯ä¿¡æ¯æ›´å‹å¥½
        """
        errors = super().errors
        verbose_errors = {}

        # è·å–æ‰€æœ‰å­—æ®µçš„ verbose_name
        fields = {
            field.name: field.verbose_name
            for field in self.Meta.model._meta.get_fields()
            if hasattr(field, 'verbose_name')
        }

        # æ›¿æ¢é”™è¯¯ä¿¡æ¯ä¸­çš„å­—æ®µåä¸º verbose_name
        for field_name, error in errors.items():
            if field_name in fields:
                verbose_errors[str(fields[field_name])] = error
            else:
                verbose_errors[field_name] = error
        return verbose_errors
```

### æä¾›çš„åŠŸèƒ½

#### 1. è‡ªåŠ¨å®¡è®¡å­—æ®µå¡«å……

| æ“ä½œ | è‡ªåŠ¨å¡«å……çš„å­—æ®µ | è¯´æ˜ |
|------|--------------|------|
| **create** | `creator` | å½“å‰ç”¨æˆ·å¯¹è±¡ |
| **create** | `modifier` | å½“å‰ç”¨æˆ·IDï¼ˆå­—ç¬¦ä¸²ï¼‰ |
| **create** | `dept_belong_id` | å½“å‰ç”¨æˆ·éƒ¨é—¨ID |
| **update** | `modifier` | å½“å‰ç”¨æˆ·IDï¼ˆå­—ç¬¦ä¸²ï¼‰ |

#### 2. æ—¶é—´æ ¼å¼åŒ–

```python
# ç»Ÿä¸€çš„æ—¶é—´æ ¼å¼
create_datetime = "2024-01-25 10:00:00"
update_datetime = "2024-01-25 10:00:00"
```

#### 3. å‹å¥½çš„é”™è¯¯ä¿¡æ¯

```python
# åŸå§‹é”™è¯¯
{
    "title": ["This field is required."],
    "price": ["This field is required."]
}

# ä½¿ç”¨ CustomModelSerializer å
{
    "ä¹¦å": ["This field is required."],
    "ä»·æ ¼": ["This field is required."]
}
```

#### 4. Request å¯¹è±¡è‡ªåŠ¨æ³¨å…¥

```python
# åœ¨åºåˆ—åŒ–å™¨ä¸­å¯ä»¥ç›´æ¥è®¿é—® request
def validate_title(self, value):
    user = self.request.user  # ç›´æ¥è®¿é—®
    # ä¸šåŠ¡é€»è¾‘
    return value
```

### ä½¿ç”¨ç¤ºä¾‹

```python
from dvadmin.utils.serializers import CustomModelSerializer
from dvadmin.system.models import Book

class BookSerializer(CustomModelSerializer):
    """
    ç»§æ‰¿ CustomModelSerializer
    è‡ªåŠ¨è·å¾—ï¼š
    1. å®¡è®¡å­—æ®µè‡ªåŠ¨å¡«å……
    2. æ—¶é—´æ ¼å¼åŒ–
    3. å‹å¥½é”™è¯¯ä¿¡æ¯
    4. Request å¯¹è±¡è®¿é—®
    """
    # è‡ªå®šä¹‰å­—æ®µ
    category_name = serializers.CharField(
        source='category.name',
        read_only=True
    )

    # è®¡ç®—å­—æ®µ
    is_available = serializers.SerializerMethodField()

    def get_is_available(self, obj):
        """åˆ¤æ–­æ˜¯å¦å¯å€Ÿ"""
        return obj.stock > 0 and obj.is_available

    class Meta:
        model = Book
        fields = '__all__'
        # è‡ªåŠ¨åŒ…å« CoreModel çš„æ‰€æœ‰å®¡è®¡å­—æ®µ

# ä½¿ç”¨ç¤ºä¾‹ï¼ˆåœ¨è§†å›¾ä¸­ï¼‰
from dvadmin.utils.viewset import CustomModelViewSet

class BookViewSet(CustomModelViewSet):
    queryset = Book.objects.all()
    serializer_class = BookSerializer

    def create(self, request, *args, **kwargs):
        # è‡ªåŠ¨æ³¨å…¥ request
        serializer = self.get_serializer(
            data=request.data,
            request=request  # â† ä¼ é€’ request
        )
        serializer.is_valid(raise_exception=True)

        # ä¿å­˜æ—¶è‡ªåŠ¨å¡«å……å®¡è®¡å­—æ®µ
        # book.creator = request.user
        # book.modifier = str(request.user.id)
        # book.dept_belong_id = request.user.dept_id
        self.perform_create(serializer)

        return DetailResponse(data=serializer.data, msg="æ–°å¢æˆåŠŸ")
```

### åºåˆ—åŒ–å™¨ç»§æ‰¿å…³ç³»

```
ModelSerializer (DRF)
        â†‘
        â”‚ ç»§æ‰¿
        â”‚
DynamicFieldsMixin (django-restql)
        â†‘
        â”‚ ç»§æ‰¿
        â”‚
CustomModelSerializer (DVAdmin)
        â†‘
        â”‚ ç»§æ‰¿
        â”‚
BookSerializer (ä¸šåŠ¡ä»£ç )
```

### æ³¨æ„äº‹é¡¹

1. **request ä¼ é€’** - ä½¿ç”¨æ—¶å¿…é¡»ä¼ é€’ `request` å‚æ•°
2. **åŒ¿åç”¨æˆ·** - åŒ¿åç”¨æˆ·ä¸ä¼šå¡«å……å®¡è®¡å­—æ®µ
3. **å­—æ®µè¦†ç›–** - å¯ä»¥è¦†ç›– `modifier_field_id` ç­‰é…ç½®
4. **é”™è¯¯å¤„ç†** - ä½¿ç”¨ `verbose_name` ä½œä¸ºé”™è¯¯å­—æ®µåï¼Œç¡®ä¿æ¨¡å‹å­—æ®µéƒ½æœ‰ `verbose_name`

---

## CustomModelViewSet - è§†å›¾é›†åŸºç±»

### æºç ä½ç½®

`backend/dvadmin/utils/viewset.py:28-165`

### æºç è§£æ

```python
class CustomModelViewSet(ModelViewSet, ImportSerializerMixin,
                         ExportSerializerMixin, QueryArgumentsMixin):
    """
    è‡ªå®šä¹‰çš„ ModelViewSetï¼š
    ç»Ÿä¸€æ ‡å‡†çš„è¿”å›æ ¼å¼ï¼›æ–°å¢ã€æŸ¥è¯¢ã€ä¿®æ”¹å¯ä½¿ç”¨ä¸åŒåºåˆ—åŒ–å™¨
    (1) ORMæ€§èƒ½ä¼˜åŒ–ï¼Œå°½å¯èƒ½ä½¿ç”¨values_querysetå½¢å¼
    (2) xxx_serializer_class æŸä¸ªæ–¹æ³•ä¸‹ä½¿ç”¨çš„åºåˆ—åŒ–å™¨
    (3) filter_fields = '__all__' é»˜è®¤æ”¯æŒå…¨éƒ¨modelä¸­çš„å­—æ®µæŸ¥è¯¢
    (4) import_field_dict={} å¯¼å…¥æ—¶çš„å­—æ®µå­—å…¸
    (5) export_field_label = [] å¯¼å‡ºæ—¶çš„å­—æ®µ
    """
    # é…ç½®é¡¹
    values_queryset = None           # å€¼æŸ¥è¯¢é›†ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
    ordering_fields = '__all__'      # æ’åºå­—æ®µ
    create_serializer_class = None   # åˆ›å»ºæ—¶ä¸“ç”¨åºåˆ—åŒ–å™¨
    update_serializer_class = None   # æ›´æ–°æ—¶ä¸“ç”¨åºåˆ—åŒ–å™¨
    filter_fields = '__all__'        # è¿‡æ»¤å­—æ®µ
    search_fields = ()               # æœç´¢å­—æ®µ
    extra_filter_class = [           # é¢å¤–è¿‡æ»¤å™¨
        CoreModelFilterBankend,
        DataLevelPermissionMargeFilter
    ]
    permission_classes = [CustomPermission]  # æƒé™ç±»
    import_field_dict = {}           # å¯¼å…¥å­—æ®µå­—å…¸
    export_field_label = {}          # å¯¼å‡ºå­—æ®µæ ‡ç­¾

    def filter_queryset(self, queryset):
        """åº”ç”¨æ‰€æœ‰è¿‡æ»¤å™¨"""
        for backend in set(set(self.filter_backends) | set(self.extra_filter_class or [])):
            queryset = backend().filter_queryset(self.request, queryset, self)
        return queryset

    def get_queryset(self):
        """è·å–æŸ¥è¯¢é›†"""
        if getattr(self, 'values_queryset', None):
            return self.values_queryset
        return super().get_queryset()

    def get_serializer_class(self):
        """
        æ ¹æ®æ“ä½œç±»å‹è¿”å›ä¸åŒçš„åºåˆ—åŒ–å™¨
        æ”¯æŒå¤šåºåˆ—åŒ–å™¨ç­–ç•¥
        """
        action_serializer_name = f"{self.action}_serializer_class"
        action_serializer_class = getattr(self, action_serializer_name, None)
        if action_serializer_class:
            return action_serializer_class
        return super().get_serializer_class()

    def get_serializer(self, *args, **kwargs):
        """
        è·å–åºåˆ—åŒ–å™¨ï¼Œè‡ªåŠ¨æ³¨å…¥ request
        åº”ç”¨å­—æ®µçº§æƒé™è¿‡æ»¤
        """
        serializer_class = self.get_serializer_class()
        kwargs.setdefault('context', self.get_serializer_context())

        # è·å–å­—æ®µæƒé™ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼ï¼‰
        can_see = self.get_menu_field(serializer_class)
        # ä¿å­˜æƒé™ä¿¡æ¯åˆ° requestï¼ˆä¾›åˆ†é¡µå™¨ä½¿ç”¨ï¼‰
        self.request.permission_fields = can_see

        # æ”¯æŒæ‰¹é‡æ“ä½œ
        if isinstance(self.request.data, list):
            with transaction.atomic():
                return serializer_class(many=True, *args, **kwargs)
        else:
            return serializer_class(*args, **kwargs)

    def get_menu_field(self, serializer_class):
        """
        è·å–å­—æ®µæƒé™ï¼ˆDVAdmin æ ¸å¿ƒåŠŸèƒ½ï¼‰
        æ ¹æ®ç”¨æˆ·è§’è‰²è¿”å›å¯è®¿é—®çš„å­—æ®µåˆ—è¡¨
        """
        # æ£€æŸ¥æ¨¡å‹æ˜¯å¦åœ¨è‡ªå®šä¹‰æ¨¡å‹åˆ—è¡¨ä¸­
        if not any(model['object'] is serializer_class.Meta.model
                  for model in get_custom_app_models()):
            return []

        # æŸ¥è¯¢å­—æ®µæƒé™
        ret = FieldPermission.objects.filter(
            field__model=serializer_class.Meta.model.__name__
        )

        # å¦‚æœç”¨æˆ·æœ‰è§’è‰²ï¼Œè¿‡æ»¤è§’è‰²çš„æƒé™
        if hasattr(self.request.user, 'role'):
            roles = self.request.user.role.values_list('id', flat=True)
            ret = ret.filter(is_query=True, role__in=roles)

        return ret.values_list('field__field_name', flat=True)

    # CRUD æ–¹æ³•ï¼ˆç»Ÿä¸€å“åº”æ ¼å¼ï¼‰
    def create(self, request, *args, **kwargs):
        """åˆ›å»º"""
        serializer = self.get_serializer(data=request.data, request=request)
        serializer.is_valid(raise_exception=True)
        self.perform_create(serializer)
        return DetailResponse(data=serializer.data, msg="æ–°å¢æˆåŠŸ")

    def list(self, request, *args, **kwargs):
        """åˆ—è¡¨"""
        queryset = self.filter_queryset(self.get_queryset())
        page = self.paginate_queryset(queryset)
        if page is not None:
            serializer = self.get_serializer(page, many=True, request=request)
            return self.get_paginated_response(serializer.data)
        serializer = self.get_serializer(queryset, many=True, request=request)
        return SuccessResponse(data=serializer.data, msg="è·å–æˆåŠŸ")

    def retrieve(self, request, *args, **kwargs):
        """è¯¦æƒ…"""
        instance = self.get_object()
        serializer = self.get_serializer(instance)
        return DetailResponse(data=serializer.data, msg="è·å–æˆåŠŸ")

    def update(self, request, *args, **kwargs):
        """æ›´æ–°"""
        partial = kwargs.pop('partial', False)
        instance = self.get_object()
        serializer = self.get_serializer(
            instance, data=request.data, request=request, partial=partial
        )
        serializer.is_valid(raise_exception=True)
        self.perform_update(serializer)

        if getattr(instance, '_prefetched_objects_cache', None):
            instance._prefetched_objects_cache = {}
        return DetailResponse(data=serializer.data, msg="æ›´æ–°æˆåŠŸ")

    def destroy(self, request, *args, **kwargs):
        """åˆ é™¤"""
        instance = self.get_object()
        instance.delete()
        return DetailResponse(data=[], msg="åˆ é™¤æˆåŠŸ")

    # æ‰¹é‡æ“ä½œ
    @action(methods=['delete'], detail=False)
    def multiple_delete(self, request, *args, **kwargs):
        """æ‰¹é‡åˆ é™¤"""
        request_data = request.data
        keys = request_data.get('keys', None)
        if keys:
            self.get_queryset().filter(id__in=keys).delete()
            return SuccessResponse(data=[], msg="åˆ é™¤æˆåŠŸ")
        else:
            return ErrorResponse(msg="æœªè·å–åˆ°keyså­—æ®µ")

    @action(methods=['post'], detail=False)
    def get_by_ids(self, request):
        """é€šè¿‡IDåˆ—è¡¨è·å–æ•°æ®"""
        ids = request.data.get('ids', [])
        if ids and ids != ['']:
            queryset = self.get_queryset().filter(id__in=ids)
            serializer = self.get_serializer(queryset, many=True)
            return DetailResponse(data=serializer.data)
        return DetailResponse(data=None)
```

### æä¾›çš„åŠŸèƒ½

#### 1. è‡ªåŠ¨ CRUD æ¥å£

| æ–¹æ³• | HTTP | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| `list()` | GET | `/book/` | è·å–åˆ—è¡¨ |
| `create()` | POST | `/book/` | åˆ›å»ºè®°å½• |
| `retrieve()` | GET | `/book/{id}/` | è·å–è¯¦æƒ… |
| `update()` | PUT | `/book/{id}/` | æ›´æ–°è®°å½• |
| `destroy()` | DELETE | `/book/{id}/` | åˆ é™¤è®°å½• |

#### 2. å¤šåºåˆ—åŒ–å™¨æ”¯æŒ

```python
class BookViewSet(CustomModelViewSet):
    serializer_class = BookSerializer              # é»˜è®¤
    create_serializer_class = BookCreateSerializer  # åˆ›å»ºæ—¶
    update_serializer_class = BookUpdateSerializer  # æ›´æ–°æ—¶
    list_serializer_class = BookListSerializer     # åˆ—è¡¨æ—¶
    retrieve_serializer_class = BookDetailSerializer  # è¯¦æƒ…æ—¶
```

#### 3. å­—æ®µçº§æƒé™

æ ¹æ®ç”¨æˆ·è§’è‰²è‡ªåŠ¨è¿‡æ»¤å¯è®¿é—®çš„å­—æ®µï¼š

```python
# é…ç½®ï¼šæ™®é€šç”¨æˆ·åªèƒ½çœ‹åˆ°éƒ¨åˆ†å­—æ®µ
FieldPermission.objects.create(
    role=æ™®é€šç”¨æˆ·è§’è‰²,
    field__model='Book',
    field__field_name='title',
    is_query=True
)
# priceã€stock å­—æ®µæœªæˆæƒï¼Œè‡ªåŠ¨è¿‡æ»¤
```

#### 4. æ•°æ®çº§æƒé™

è‡ªåŠ¨è¿‡æ»¤æ•°æ®èŒƒå›´ï¼š

```python
# æ•°æ®æƒé™èŒƒå›´
1 = å…¨éƒ¨æ•°æ®æƒé™       # èƒ½çœ‹åˆ°æ‰€æœ‰æ•°æ®
2 = è‡ªå®šä¹‰æ•°æ®æƒé™      # æŒ‡å®šéƒ¨é—¨çš„æ•°æ®
3 = æœ¬éƒ¨é—¨æ•°æ®æƒé™      # åªèƒ½çœ‹åˆ°æœ¬éƒ¨é—¨çš„æ•°æ®
4 = æœ¬éƒ¨é—¨åŠä»¥ä¸‹æ•°æ®æƒé™ # æœ¬éƒ¨é—¨ + å­éƒ¨é—¨
5 = ä»…æœ¬äººæ•°æ®æƒé™      # åªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„æ•°æ®
```

#### 5. æ‰¹é‡æ“ä½œ

```python
# æ‰¹é‡åˆ›å»º
POST /api/system/book/
Body: [
    {"title": "Book1", "price": 10},
    {"title": "Book2", "price": 20}
]

# æ‰¹é‡åˆ é™¤
DELETE /api/system/book/multiple_delete/
Body: {"keys": [1, 2, 3]}

# æ‰¹é‡æŸ¥è¯¢
POST /api/system/book/get_by_ids/
Body: {"ids": [1, 2, 3]}
```

#### 6. ç»Ÿä¸€å“åº”æ ¼å¼

```python
# æˆåŠŸå“åº”
{
    "code": 2000,
    "msg": "æ“ä½œæˆåŠŸ",
    "data": {...}
}

# é”™è¯¯å“åº”
{
    "code": 2001,
    "msg": "é”™è¯¯ä¿¡æ¯",
    "data": null
}

# åˆ—è¡¨å“åº”
{
    "code": 2000,
    "msg": "è·å–æˆåŠŸ",
    "data": [...],
    "total": 100,
    "page": 1,
    "limit": 10
}
```

### ä½¿ç”¨ç¤ºä¾‹

```python
from dvadmin.utils.viewset import CustomModelViewSet
from dvadmin.system.models import Book
from dvadmin.system.serializers import (
    BookSerializer,
    BookCreateSerializer,
    BookUpdateSerializer,
    BookListSerializer
)

class BookViewSet(CustomModelViewSet):
    """
    ç»§æ‰¿ CustomModelViewSet
    è‡ªåŠ¨è·å¾—ï¼š
    1. å®Œæ•´çš„ CRUD æ¥å£
    2. å­—æ®µçº§æƒé™æ§åˆ¶
    3. æ•°æ®çº§æƒé™æ§åˆ¶
    4. æ‰¹é‡æ“ä½œæ”¯æŒ
    5. ç»Ÿä¸€å“åº”æ ¼å¼
    """

    # åŸºç¡€é…ç½®
    queryset = Book.objects.select_related('category', 'author').all()
    serializer_class = BookSerializer

    # å¤šåºåˆ—åŒ–å™¨é…ç½®
    create_serializer_class = BookCreateSerializer
    update_serializer_class = BookUpdateSerializer
    list_serializer_class = BookListSerializer

    # è¿‡æ»¤å’Œæœç´¢
    filter_fields = ['title', 'isbn', 'category', 'author']
    search_fields = ('title', 'description')
    ordering_fields = '__all__'

    # è‡ªå®šä¹‰æ“ä½œ
    @action(methods=['get'], detail=False)
    def statistics(self, request):
        """è‡ªå®šä¹‰æ“ä½œï¼šç»Ÿè®¡ä¿¡æ¯"""
        total_books = self.queryset.count()
        total_categories = BookCategory.objects.count()

        data = {
            'total_books': total_books,
            'total_categories': total_categories,
        }

        return DetailResponse(data=data, msg="è·å–ç»Ÿè®¡ä¿¡æ¯æˆåŠŸ")

    @action(methods=['post'], detail=True)
    def mark_unavailable(self, request, pk=None):
        """è‡ªå®šä¹‰æ“ä½œï¼šæ ‡è®°ä¸ºä¸å¯å€Ÿé˜…"""
        book = self.get_object()
        book.is_available = False
        book.save()
        return DetailResponse(data={'id': book.id}, msg="æ ‡è®°æˆåŠŸ")

# ç”Ÿæˆçš„è·¯ç”±
# GET    /api/system/book/                    åˆ—è¡¨
# POST   /api/system/book/                    åˆ›å»º
# GET    /api/system/book/{id}/               è¯¦æƒ…
# PUT    /api/system/book/{id}/               æ›´æ–°
# DELETE /api/system/book/{id}/               åˆ é™¤
# GET    /api/system/book/statistics/         ç»Ÿè®¡ä¿¡æ¯
# POST   /api/system/book/{id}/mark_unavailable/ æ ‡è®°ä¸å¯å€Ÿ
```

### è§†å›¾é›†ç»§æ‰¿å…³ç³»

```
ModelViewSet (DRF)
    â†‘
    â”‚ ç»§æ‰¿
    â”‚
QueryArgumentsMixin (django-restql)
    â†‘
    â”‚ ç»§æ‰¿
    â”‚
ImportSerializerMixin (DVAdmin)
    â†‘
    â”‚ ç»§æ‰¿
    â”‚
ExportSerializerMixin (DVAdmin)
    â†‘
    â”‚ ç»§æ‰¿
    â”‚
CustomModelViewSet (DVAdmin)
    â†‘
    â”‚ ç»§æ‰¿
    â”‚
BookViewSet (ä¸šåŠ¡ä»£ç )
```

### é…ç½®é¡¹è¯´æ˜

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `queryset` | QuerySet | å¿…å¡« | æŸ¥è¯¢é›† |
| `serializer_class` | Serializer | å¿…å¡« | é»˜è®¤åºåˆ—åŒ–å™¨ |
| `create_serializer_class` | Serializer | None | åˆ›å»ºæ—¶åºåˆ—åŒ–å™¨ |
| `update_serializer_class` | Serializer | None | æ›´æ–°æ—¶åºåˆ—åŒ–å™¨ |
| `list_serializer_class` | Serializer | None | åˆ—è¡¨æ—¶åºåˆ—åŒ–å™¨ |
| `filter_fields` | list/tuple | `'__all__'` | è¿‡æ»¤å­—æ®µ |
| `search_fields` | tuple | `()` | æœç´¢å­—æ®µ |
| `ordering_fields` | list/tuple | `'__all__'` | æ’åºå­—æ®µ |
| `permission_classes` | list | `[CustomPermission]` | æƒé™ç±» |

### æ³¨æ„äº‹é¡¹

1. **queryset ä¼˜åŒ–** - ä½¿ç”¨ `select_related` å’Œ `prefetch_related` ä¼˜åŒ–æŸ¥è¯¢
2. **åºåˆ—åŒ–å™¨é€‰æ‹©** - æ ¹æ®ä¸šåŠ¡éœ€è¦é…ç½®ä¸åŒåºåˆ—åŒ–å™¨
3. **æƒé™é…ç½®** - åœ¨åå°é…ç½®èœå•ã€å­—æ®µã€æ•°æ®æƒé™
4. **è‡ªå®šä¹‰æ“ä½œ** - ä½¿ç”¨ `@action` è£…é¥°å™¨æ·»åŠ è‡ªå®šä¹‰æ¥å£

---

## ä¸‰è€…åä½œå…³ç³»

### å®Œæ•´åä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å®Œæ•´è¯·æ±‚å¤„ç†æµç¨‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. å‰ç«¯å‘é€è¯·æ±‚
   â”‚
   â–¼
2. CustomModelViewSet æ¥æ”¶è¯·æ±‚
   â”‚
   â”œâ”€ æƒé™éªŒè¯ï¼ˆCustomPermissionï¼‰
   â”‚  â””â”€ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®æƒé™
   â”‚
   â”œâ”€ æ•°æ®æƒé™è¿‡æ»¤ï¼ˆDataLevelPermissionMargeFilterï¼‰
   â”‚  â””â”€ æ ¹æ®ç”¨æˆ·è§’è‰²è¿‡æ»¤æ•°æ®èŒƒå›´
   â”‚
   â”œâ”€ è·å–åºåˆ—åŒ–å™¨ï¼ˆget_serializer_classï¼‰
   â”‚  â””â”€ æ ¹æ®æ“ä½œç±»å‹é€‰æ‹©å¯¹åº”çš„åºåˆ—åŒ–å™¨
   â”‚
   â–¼
3. CustomModelSerializer å¤„ç†æ•°æ®
   â”‚
   â”œâ”€ å­—æ®µæƒé™è¿‡æ»¤ï¼ˆget_menu_fieldï¼‰
   â”‚  â””â”€ æ ¹æ®ç”¨æˆ·è§’è‰²è¿‡æ»¤å¯è®¿é—®å­—æ®µ
   â”‚
   â”œâ”€ æ•°æ®éªŒè¯ï¼ˆis_validï¼‰
   â”‚  â””â”€ éªŒè¯è¾“å…¥æ•°æ®çš„åˆæ³•æ€§
   â”‚
   â”œâ”€ è‡ªåŠ¨å¡«å……å®¡è®¡å­—æ®µï¼ˆcreate/updateï¼‰
   â”‚  â”œâ”€ creator = request.user
   â”‚  â”œâ”€ modifier = request.user.id
   â”‚  â””â”€ dept_belong_id = request.user.dept_id
   â”‚
   â–¼
4. CoreModel ä¿å­˜æ•°æ®
   â”‚
   â”œâ”€ è‡ªåŠ¨è®°å½•å®¡è®¡ä¿¡æ¯
   â”‚  â”œâ”€ create_datetime = now()
   â”‚  â”œâ”€ update_datetime = now()
   â”‚  â”œâ”€ creator = å½“å‰ç”¨æˆ·
   â”‚  â””â”€ dept_belong_id = å½“å‰éƒ¨é—¨
   â”‚
   â”œâ”€ æ•°æ®åº“æ“ä½œ
   â”‚  â””â”€ ä¿å­˜åˆ°æ•°æ®åº“
   â”‚
   â–¼
5. è¿”å›å“åº”ï¼ˆç»Ÿä¸€æ ¼å¼ï¼‰
   â”‚
   â””â”€ DetailResponse / SuccessResponse / ErrorResponse
```

### åä½œç¤ºä¾‹ï¼šåˆ›å»ºå›¾ä¹¦

```python
# ===== å‰ç«¯è¯·æ±‚ =====
POST /api/system/book/
Headers: {
    "Authorization": "JWT eyJ0eXAiOiJKV1QiLCJhbGc..."
}
Body: {
    "title": "Pythonç¼–ç¨‹",
    "price": 89.00,
    "category": 1
}

# ===== åç«¯å¤„ç†æµç¨‹ =====

# 1. CustomModelViewSet.create() æ¥æ”¶è¯·æ±‚
def create(self, request, *args, **kwargs):
    # 2. è·å–åºåˆ—åŒ–å™¨ï¼ˆè‡ªåŠ¨æ³¨å…¥ requestï¼‰
    serializer = self.get_serializer(
        data=request.data,
        request=request  # â† ä¼ é€’ request
    )

    # 3. éªŒè¯æ•°æ®
    serializer.is_valid(raise_exception=True)

    # 4. ä¿å­˜æ•°æ®ï¼ˆè§¦å‘ CustomModelSerializer.createï¼‰
    self.perform_create(serializer)

    # 7. è¿”å›å“åº”
    return DetailResponse(data=serializer.data, msg="æ–°å¢æˆåŠŸ")

# ===== CustomModelSerializer.create() =====
def create(self, validated_data):
    # 5. è‡ªåŠ¨å¡«å……å®¡è®¡å­—æ®µ
    if self.request:
        validated_data[self.creator_field_id] = self.request.user  # â† åˆ›å»ºäºº
        validated_data[self.modifier_field_id] = self.get_request_user_id()  # â† ä¿®æ”¹äºº
        validated_data[self.dept_belong_id_field_name] = self.request.user.dept_id  # â† éƒ¨é—¨

    # 6. è°ƒç”¨ CoreModel ä¿å­˜
    return super().create(validated_data)

# ===== CoreModel è‡ªåŠ¨å¡«å…… =====
# åˆ›å»º Book å¯¹è±¡æ—¶ï¼Œè‡ªåŠ¨è®¾ç½®ï¼š
book = Book(
    title="Pythonç¼–ç¨‹",
    price=89.00,
    category_id=1,
    # è‡ªåŠ¨å¡«å……ï¼š
    creator=request.user,           # â† CustomModelSerializer å¡«å……
    modifier=str(request.user.id),  # â† CustomModelSerializer å¡«å……
    dept_belong_id=request.user.dept_id,  # â† CustomModelSerializer å¡«å……
    create_datetime=now(),          # â† Django auto_now_add è‡ªåŠ¨å¡«å……
    update_datetime=now()           # â† Django auto_now è‡ªåŠ¨å¡«å……
)
book.save()  # ä¿å­˜åˆ°æ•°æ®åº“

# ===== æœ€ç»ˆæ•°æ®åº“è®°å½• =====
{
    "id": 1,
    "title": "Pythonç¼–ç¨‹",
    "price": 89.00,
    "category_id": 1,
    "creator_id": 5,              # â† è‡ªåŠ¨å¡«å……
    "modifier": "5",              # â† è‡ªåŠ¨å¡«å……
    "dept_belong_id": "10",       # â† è‡ªåŠ¨å¡«å……
    "create_datetime": "2024-01-25 10:00:00",  # â† è‡ªåŠ¨å¡«å……
    "update_datetime": "2024-01-25 10:00:00"   # â† è‡ªåŠ¨å¡«å……
}
```

### å­—æ®µæƒé™è¿‡æ»¤æµç¨‹

```python
# ===== åœºæ™¯ï¼šæ™®é€šç”¨æˆ·è®¿é—®å›¾ä¹¦åˆ—è¡¨ =====

# 1. è¯·æ±‚
GET /api/system/book/
Headers: {
    "Authorization": "JWT ..."  # æ™®é€šç”¨æˆ· token
}

# 2. CustomModelViewSet.get_serializer()
def get_serializer(self, *args, **kwargs):
    serializer_class = self.get_serializer_class()  # BookSerializer

    # 3. è·å–å­—æ®µæƒé™ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼ï¼‰
    can_see = self.get_menu_field(serializer_class)

    # æ‰§è¡ŒæŸ¥è¯¢ï¼š
    # SELECT field_name FROM dvadmin_system_fieldpermission
    # WHERE model='Book' AND is_query=True AND role IN (ç”¨æˆ·è§’è‰²)
    # ç»“æœï¼š['id', 'title', 'author']  (æ²¡æœ‰ priceã€stock)

    # 4. ä¿å­˜æƒé™ä¿¡æ¯åˆ° request
    self.request.permission_fields = can_see
    # request.permission_fields = ['id', 'title', 'author']

    # 5. è¿”å›åºåˆ—åŒ–å™¨
    return serializer_class(*args, **kwargs)

# 6. åºåˆ—åŒ–æ•°æ®
serializer = BookSerializer(queryset, many=True)
data = serializer.data

# è‡ªåŠ¨è¿‡æ»¤å­—æ®µï¼Œåªè¿”å›ç”¨æˆ·æœ‰æƒé™çš„å­—æ®µï¼š
# [
#   {"id": 1, "title": "Pythonç¼–ç¨‹", "author": "å¼ ä¸‰"},
#   {"id": 2, "title": "Djangoå®æˆ˜", "author": "æå››"}
# ]
# æ³¨æ„ï¼šprice å’Œ stock å­—æ®µè¢«è¿‡æ»¤æ‰äº†ï¼
```

### æ•°æ®æƒé™è¿‡æ»¤æµç¨‹

```python
# ===== åœºæ™¯ï¼šéƒ¨é—¨ç”¨æˆ·è®¿é—®å›¾ä¹¦åˆ—è¡¨ =====

# 1. è¯·æ±‚
GET /api/system/book/
Headers: {
    "Authorization": "JWT ..."  # éƒ¨é—¨ç”¨æˆ· token
}

# 2. CustomModelViewSet.filter_queryset()
def filter_queryset(self, queryset):
    # éå†æ‰€æœ‰è¿‡æ»¤å™¨
    for backend in [CoreModelFilterBankend, DataLevelPermissionMargeFilter]:
        queryset = backend().filter_queryset(self.request, queryset, self)
    return queryset

# 3. DataLevelPermissionMargeFilter.filter_queryset()
def filter_queryset(self, request, queryset, view):
    user = request.user

    # æ£€æŸ¥ç”¨æˆ·è§’è‰²çš„æ•°æ®æƒé™èŒƒå›´
    for role in user.role.all():
        if role.data_scope == 1:
            return queryset  # å…¨éƒ¨æ•°æ®
        elif role.data_scope == 3:
            # æœ¬éƒ¨é—¨æ•°æ®
            queryset = queryset.filter(dept_belong_id=user.dept_id)
        elif role.data_scope == 5:
            # ä»…æœ¬äººæ•°æ®
            queryset = queryset.filter(creator=user)

    return queryset

# 4. æœ€ç»ˆæ‰§è¡Œçš„ SQL
SELECT * FROM dvadmin_book
WHERE dept_belong_id = '10'  # â† è‡ªåŠ¨æ·»åŠ çš„è¿‡æ»¤æ¡ä»¶
```

### å…³è”å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸‰å¤§åŸºç±»å…³è”å…³ç³»                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Django åŸç”Ÿç±»     â”‚
                    â”‚  models.Model     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ ç»§æ‰¿
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   CoreModel      â”‚
                    â”‚  (æ ¸å¿ƒåŸºç±»)        â”‚
                    â”‚  - id             â”‚
                    â”‚  - creator       â”‚
                    â”‚  - modifier      â”‚
                    â”‚  - create_datetimeâ”‚
                    â”‚  - update_datetimeâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ ç»§æ‰¿
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      Book       â”‚          â”‚   BorrowRecord  â”‚
    â”‚   (ä¸šåŠ¡æ¨¡å‹)      â”‚          â”‚   (ä¸šåŠ¡æ¨¡å‹)      â”‚
    â”‚  - title        â”‚          â”‚  - status       â”‚
    â”‚  - price        â”‚          â”‚  - due_date     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ Meta.model æŒ‡å‘
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ BookSerializer  â”‚
    â”‚  (åºåˆ—åŒ–å™¨)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ ç»§æ‰¿
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ CustomModelSerializer    â”‚
    â”‚  (åºåˆ—åŒ–å™¨åŸºç±»)            â”‚
    â”‚  - è‡ªåŠ¨å¡«å……å®¡è®¡å­—æ®µ        â”‚
    â”‚  - æ ¼å¼åŒ–æ—¶é—´             â”‚
    â”‚  - å‹å¥½é”™è¯¯ä¿¡æ¯           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ serializer_class æŒ‡å‘
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  BookViewSet    â”‚
    â”‚  (è§†å›¾é›†)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ ç»§æ‰¿
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ CustomModelViewSet       â”‚
    â”‚  (è§†å›¾é›†åŸºç±»)              â”‚
    â”‚  - è‡ªåŠ¨ CRUD              â”‚
    â”‚  - å­—æ®µçº§æƒé™              â”‚
    â”‚  - æ•°æ®çº§æƒé™              â”‚
    â”‚  - æ‰¹é‡æ“ä½œ               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®Œæ•´ç¤ºä¾‹æ¼”ç¤º

### ç¤ºä¾‹ï¼šå›¾ä¹¦ç®¡ç†æ¨¡å—

#### 1. å®šä¹‰æ¨¡å‹ (models.py)

```python
from dvadmin.utils.models import CoreModel
from django.db import models

class Book(CoreModel):
    """
    å›¾ä¹¦æ¨¡å‹ - ç»§æ‰¿ CoreModel
    è‡ªåŠ¨è·å¾—å®¡è®¡å­—æ®µï¼šid, creator, modifier, dept_belong_id,
                    create_datetime, update_datetime
    """
    title = models.CharField(max_length=200, verbose_name="ä¹¦å")
    isbn = models.CharField(max_length=13, unique=True, verbose_name="ISBN")
    category = models.ForeignKey('BookCategory', on_delete=models.PROTECT, verbose_name="åˆ†ç±»")
    author = models.ForeignKey('BookAuthor', on_delete=models.PROTECT, verbose_name="ä½œè€…")
    publisher = models.CharField(max_length=100, verbose_name="å‡ºç‰ˆç¤¾")
    price = models.DecimalField(max_digits=10, decimal_places=2, verbose_name="ä»·æ ¼")
    stock = models.IntegerField(default=0, verbose_name="åº“å­˜")

    class Meta:
        db_table = 'dvadmin_book'
        verbose_name = 'å›¾ä¹¦'
```

#### 2. å®šä¹‰åºåˆ—åŒ–å™¨ (serializers.py)

```python
from dvadmin.utils.serializers import CustomModelSerializer
from dvadmin.system.models import Book

class BookSerializer(CustomModelSerializer):
    """
    å›¾ä¹¦åºåˆ—åŒ–å™¨ - ç»§æ‰¿ CustomModelSerializer
    è‡ªåŠ¨è·å¾—ï¼š
    - å®¡è®¡å­—æ®µè‡ªåŠ¨å¡«å……
    - æ—¶é—´æ ¼å¼åŒ–
    - å‹å¥½é”™è¯¯ä¿¡æ¯
    - Request å¯¹è±¡è®¿é—®
    """
    # è‡ªå®šä¹‰å­—æ®µ
    category_name = serializers.CharField(source='category.name', read_only=True)
    author_name = serializers.CharField(source='author.name', read_only=True)

    class Meta:
        model = Book
        fields = '__all__'  # åŒ…å«æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬å®¡è®¡å­—æ®µï¼‰

class BookCreateSerializer(CustomModelSerializer):
    """åˆ›å»ºæ—¶ä¸“ç”¨åºåˆ—åŒ–å™¨"""
    def validate_isbn(self, value):
        """éªŒè¯ ISBN æ ¼å¼"""
        if len(value) != 13:
            raise serializers.ValidationError("ISBN å¿…é¡»æ˜¯ 13 ä½")
        return value

    def validate_price(self, value):
        """éªŒè¯ä»·æ ¼"""
        if value <= 0:
            raise serializers.ValidationError("ä»·æ ¼å¿…é¡»å¤§äº 0")
        return value

    class Meta:
        model = Book
        fields = '__all__'

class BookListSerializer(CustomModelSerializer):
    """åˆ—è¡¨æ—¶ä¸“ç”¨åºåˆ—åŒ–å™¨ï¼ˆç²¾ç®€å­—æ®µï¼‰"""
    category_name = serializers.CharField(source='category.name', read_only=True)
    author_name = serializers.CharField(source='author.name', read_only=True)

    class Meta:
        model = Book
        fields = ['id', 'title', 'isbn', 'category_name', 'author_name',
                  'publisher', 'price', 'stock']
```

#### 3. å®šä¹‰è§†å›¾é›† (views.py)

```python
from dvadmin.utils.viewset import CustomModelViewSet
from dvadmin.system.models import Book
from dvadmin.system.serializers import (
    BookSerializer,
    BookCreateSerializer,
    BookListSerializer
)

class BookViewSet(CustomModelViewSet):
    """
    å›¾ä¹¦è§†å›¾é›† - ç»§æ‰¿ CustomModelViewSet
    è‡ªåŠ¨è·å¾—ï¼š
    - å®Œæ•´çš„ CRUD æ¥å£
    - å­—æ®µçº§æƒé™æ§åˆ¶
    - æ•°æ®çº§æƒé™æ§åˆ¶
    - æ‰¹é‡æ“ä½œæ”¯æŒ
    - ç»Ÿä¸€å“åº”æ ¼å¼
    """
    queryset = Book.objects.select_related('category', 'author').all()
    serializer_class = BookSerializer

    # å¤šåºåˆ—åŒ–å™¨é…ç½®
    create_serializer_class = BookCreateSerializer
    list_serializer_class = BookListSerializer

    # è¿‡æ»¤å’Œæœç´¢
    filter_fields = ['title', 'isbn', 'category', 'author']
    search_fields = ('title', 'isbn')
    ordering_fields = '__all__'

    # è‡ªå®šä¹‰æ“ä½œ
    from rest_framework.decorators import action
    from dvadmin.utils.json_response import DetailResponse

    @action(methods=['get'], detail=False)
    def statistics(self, request):
        """ç»Ÿè®¡ä¿¡æ¯"""
        total_books = self.queryset.count()
        out_of_stock = self.queryset.filter(stock=0).count()

        data = {
            'total_books': total_books,
            'out_of_stock': out_of_stock,
        }

        return DetailResponse(data=data, msg="è·å–ç»Ÿè®¡ä¿¡æ¯æˆåŠŸ")
```

#### 4. é…ç½®è·¯ç”± (urls.py)

```python
from rest_framework.routers import SimpleRouter
from dvadmin.system.views.book import BookViewSet

router = SimpleRouter()
router.register(r'book', BookViewSet)

urlpatterns += [
    path('api/system/', include(router.urls)),
]
```

#### 5. æµ‹è¯•æ¥å£

```bash
# 1. åˆ›å»ºå›¾ä¹¦
POST /api/system/book/
Headers: {"Authorization": "JWT ..."}
Body: {
    "title": "Pythonç¼–ç¨‹ä»å…¥é—¨åˆ°ç²¾é€š",
    "isbn": "9787111111111",
    "category": 1,
    "author": 1,
    "publisher": "æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾",
    "price": 89.00,
    "stock": 10
}

# å“åº”
{
    "code": 2000,
    "msg": "æ–°å¢æˆåŠŸ",
    "data": {
        "id": 1,
        "title": "Pythonç¼–ç¨‹ä»å…¥é—¨åˆ°ç²¾é€š",
        "isbn": "9787111111111",
        "category": 1,
        "category_name": "è®¡ç®—æœºæŠ€æœ¯",
        "author": 1,
        "author_name": "å¼ ä¸‰",
        "publisher": "æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾",
        "price": 89.00,
        "stock": 10,
        "creator": 5,              # â† è‡ªåŠ¨å¡«å……
        "modifier": "5",           # â† è‡ªåŠ¨å¡«å……
        "dept_belong_id": "10",    # â† è‡ªåŠ¨å¡«å……
        "create_datetime": "2024-01-25 10:00:00",  # â† è‡ªåŠ¨å¡«å……
        "update_datetime": "2024-01-25 10:00:00"   # â† è‡ªåŠ¨å¡«å……
    }
}

# 2. è·å–åˆ—è¡¨
GET /api/system/book/?search=Python&category=1
Headers: {"Authorization": "JWT ..."}

# å“åº”
{
    "code": 2000,
    "msg": "è·å–æˆåŠŸ",
    "data": [
        {
            "id": 1,
            "title": "Pythonç¼–ç¨‹ä»å…¥é—¨åˆ°ç²¾é€š",
            "isbn": "9787111111111",
            "category_name": "è®¡ç®—æœºæŠ€æœ¯",
            "author_name": "å¼ ä¸‰",
            "price": 89.00,
            "stock": 10
        }
    ],
    "total": 1,
    "page": 1,
    "limit": 10
}

# 3. è·å–ç»Ÿè®¡ä¿¡æ¯
GET /api/system/book/statistics/
Headers: {"Authorization": "JWT ..."}

# å“åº”
{
    "code": 2000,
    "msg": "è·å–ç»Ÿè®¡ä¿¡æ¯æˆåŠŸ",
    "data": {
        "total_books": 100,
        "out_of_stock": 3
    }
}
```

---

## è®¾è®¡æ¨¡å¼åˆ†æ

### 1. æ¨¡æ¿æ–¹æ³•æ¨¡å¼

```python
# CustomModelViewSet å®šä¹‰æ¨¡æ¿æ–¹æ³•
def get_serializer_class(self):
    """æ¨¡æ¿æ–¹æ³•ï¼šå­ç±»å¯ä»¥é€šè¿‡é…ç½®æŒ‡å®šä¸åŒåºåˆ—åŒ–å™¨"""
    action_serializer_name = f"{self.action}_serializer_class"
    action_serializer_class = getattr(self, action_serializer_name, None)
    if action_serializer_class:
        return action_serializer_class
    return super().get_serializer_class()

# ä½¿ç”¨
class BookViewSet(CustomModelViewSet):
    serializer_class = BookSerializer              # é»˜è®¤
    create_serializer_class = BookCreateSerializer  # åˆ›å»ºæ—¶
    update_serializer_class = BookUpdateSerializer  # æ›´æ–°æ—¶
```

### 2. è´£ä»»é“¾æ¨¡å¼

```python
# è¿‡æ»¤å™¨é“¾
def filter_queryset(self, queryset):
    for backend in [
        CoreModelFilterBankend,           # 1. æ ¸å¿ƒæ¨¡å‹è¿‡æ»¤
        DataLevelPermissionMargeFilter,   # 2. æ•°æ®æƒé™è¿‡æ»¤
        SearchFilter,                     # 3. æœç´¢è¿‡æ»¤
        OrderingFilter                    # 4. æ’åºè¿‡æ»¤
    ]:
        queryset = backend().filter_queryset(self.request, queryset, self)
    return queryset
```

### 3. ç­–ç•¥æ¨¡å¼

```python
# ä¸åŒæ“ä½œä½¿ç”¨ä¸åŒç­–ç•¥ï¼ˆåºåˆ—åŒ–å™¨ï¼‰
class BookViewSet(CustomModelViewSet):
    # ç­–ç•¥1: åˆ›å»ºç­–ç•¥
    create_serializer_class = BookCreateSerializer

    # ç­–ç•¥2: æ›´æ–°ç­–ç•¥
    update_serializer_class = BookUpdateSerializer

    # ç­–ç•¥3: åˆ—è¡¨ç­–ç•¥
    list_serializer_class = BookListSerializer
```

### 4. å·¥å‚æ¨¡å¼

```python
# åºåˆ—åŒ–å™¨å·¥å‚
def get_serializer_class(self):
    """æ ¹æ®æ“ä½œç±»å‹åŠ¨æ€åˆ›å»ºåºåˆ—åŒ–å™¨"""
    # æ ¹æ®ä¸åŒçš„ actionï¼ˆlist, create, update...ï¼‰
    # è¿”å›ä¸åŒçš„åºåˆ—åŒ–å™¨ç±»
    pass
```

### 5. è£…é¥°å™¨æ¨¡å¼

```python
# @action è£…é¥°å™¨æ·»åŠ è‡ªå®šä¹‰æ“ä½œ
@action(methods=['get'], detail=False)
def statistics(self, request):
    """ä¸ºè§†å›¾é›†æ·»åŠ é¢å¤–çš„è‡ªå®šä¹‰æ“ä½œ"""
    pass
```

---

## æœ€ä½³å®è·µ

### 1. æ¨¡å‹å®šä¹‰

```python
# âœ… æ¨èï¼šç»§æ‰¿ CoreModel
class Book(CoreModel):
    title = models.CharField(max_length=200, verbose_name="ä¹¦å")
    # ä¸šåŠ¡å­—æ®µ...

    class Meta:
        db_table = 'dvadmin_book'
        verbose_name = 'å›¾ä¹¦'

# âŒ ä¸æ¨èï¼šä¸ç»§æ‰¿ CoreModel
class Book(models.Model):
    title = models.CharField(max_length=200)
    # ç¼ºå°‘å®¡è®¡å­—æ®µï¼Œæ— æ³•è¿›è¡Œæƒé™æ§åˆ¶å’Œå®¡è®¡
```

### 2. åºåˆ—åŒ–å™¨å®šä¹‰

```python
# âœ… æ¨èï¼šç»§æ‰¿ CustomModelSerializer
class BookSerializer(CustomModelSerializer):
    class Meta:
        model = Book
        fields = '__all__'

# âŒ ä¸æ¨èï¼šç»§æ‰¿ ModelSerializer
class BookSerializer(ModelSerializer):
    # ç¼ºå°‘å®¡è®¡å­—æ®µè‡ªåŠ¨å¡«å……å’Œæ ¼å¼åŒ–åŠŸèƒ½
```

### 3. è§†å›¾é›†å®šä¹‰

```python
# âœ… æ¨èï¼šç»§æ‰¿ CustomModelViewSet
class BookViewSet(CustomModelViewSet):
    queryset = Book.objects.all()
    serializer_class = BookSerializer

# âŒ ä¸æ¨èï¼šç»§æ‰¿ ModelViewSet
class BookViewSet(ModelViewSet):
    # ç¼ºå°‘æƒé™æ§åˆ¶å’Œç»Ÿä¸€å“åº”æ ¼å¼
```

### 4. queryset ä¼˜åŒ–

```python
# âœ… æ¨èï¼šä½¿ç”¨ select_related ä¼˜åŒ–æŸ¥è¯¢
class BookViewSet(CustomModelViewSet):
    queryset = Book.objects.select_related(
        'category', 'author'
    ).all()

# âŒ ä¸æ¨èï¼šä¸ä½¿ç”¨ select_related
class BookViewSet(CustomModelViewSet):
    queryset = Book.objects.all()
    # ä¼šäº§ç”Ÿ N+1 æŸ¥è¯¢é—®é¢˜
```

### 5. å¤šåºåˆ—åŒ–å™¨ä½¿ç”¨

```python
# âœ… æ¨èï¼šä¸ºä¸åŒæ“ä½œä½¿ç”¨ä¸åŒåºåˆ—åŒ–å™¨
class BookViewSet(CustomModelViewSet):
    serializer_class = BookSerializer              # é»˜è®¤
    create_serializer_class = BookCreateSerializer  # åˆ›å»º
    update_serializer_class = BookUpdateSerializer  # æ›´æ–°
    list_serializer_class = BookListSerializer     # åˆ—è¡¨

# å¥½å¤„ï¼š
# - åˆ›å»ºæ—¶å¯ä»¥æ·»åŠ é¢å¤–éªŒè¯
# - æ›´æ–°æ—¶å¯ä»¥é™åˆ¶æŸäº›å­—æ®µä¸å¯ä¿®æ”¹
# - åˆ—è¡¨æ—¶å¯ä»¥ç²¾ç®€å­—æ®µæé«˜æ€§èƒ½
```

### 6. æƒé™é…ç½®

```python
# âœ… æ¨èï¼šåœ¨åå°é…ç½®æƒé™
# 1. èœå•æƒé™ï¼šæ§åˆ¶ç”¨æˆ·èƒ½è®¿é—®å“ªäº›é¡µé¢
# 2. æŒ‰é’®æƒé™ï¼šæ§åˆ¶ç”¨æˆ·èƒ½æ‰§è¡Œå“ªäº›æ“ä½œ
# 3. å­—æ®µæƒé™ï¼šæ§åˆ¶ç”¨æˆ·èƒ½çœ‹åˆ°å“ªäº›å­—æ®µ
# 4. æ•°æ®æƒé™ï¼šæ§åˆ¶ç”¨æˆ·èƒ½çœ‹åˆ°å“ªäº›æ•°æ®

# âŒ ä¸æ¨èï¼šåœ¨ä»£ç ä¸­ç¡¬ç¼–ç æƒé™
if request.user.role.name == 'ç®¡ç†å‘˜':
    # ä¸çµæ´»ï¼Œä¸æ˜“ç»´æŠ¤
```

### 7. é”™è¯¯å¤„ç†

```python
# âœ… æ¨èï¼šä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å“åº”
from dvadmin.utils.json_response import ErrorResponse

if book.stock <= 0:
    return ErrorResponse(msg="åº“å­˜ä¸è¶³")

# âŒ ä¸æ¨èï¼šç›´æ¥è¿”å› DRF é”™è¯¯
from rest_framework.response import Response
return Response({'error': 'åº“å­˜ä¸è¶³'}, status=400)
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **CoreModel** - æ•°æ®æ¨¡å‹åŸºç±»
   - æä¾›å®¡è®¡å­—æ®µï¼ˆåˆ›å»ºäººã€ä¿®æ”¹äººã€æ—¶é—´ç­‰ï¼‰
   - è‡ªåŠ¨è®°å½•æ•°æ®å½’å±éƒ¨é—¨
   - æä¾›è¾…åŠ©æ–¹æ³•ç®€åŒ–å¼€å‘

2. **CustomModelSerializer** - åºåˆ—åŒ–å™¨åŸºç±»
   - è‡ªåŠ¨å¡«å……å®¡è®¡å­—æ®µ
   - ç»Ÿä¸€æ—¶é—´æ ¼å¼
   - å‹å¥½çš„é”™è¯¯ä¿¡æ¯
   - è‡ªåŠ¨æ³¨å…¥ request å¯¹è±¡

3. **CustomModelViewSet** - è§†å›¾é›†åŸºç±»
   - è‡ªåŠ¨ç”Ÿæˆ CRUD æ¥å£
   - å­—æ®µçº§æƒé™æ§åˆ¶
   - æ•°æ®çº§æƒé™æ§åˆ¶
   - æ‰¹é‡æ“ä½œæ”¯æŒ
   - ç»Ÿä¸€å“åº”æ ¼å¼

### åä½œå…³ç³»

```
ç”¨æˆ·è¯·æ±‚
    â†“
CustomModelViewSet (ä¸šåŠ¡é€»è¾‘æ§åˆ¶)
    â†“ é€‰æ‹©
CustomModelSerializer (æ•°æ®å¤„ç†ä¸éªŒè¯)
    â†“ æ“ä½œ
CoreModel (æ•°æ®å­˜å‚¨)
    â†“
æ•°æ®åº“
```

### è®¾è®¡ä¼˜åŠ¿

1. **é«˜å†…èšä½è€¦åˆ** - æ¯ä¸ªåŸºç±»èŒè´£å•ä¸€ï¼Œç›¸äº’ç‹¬ç«‹
2. **å¼€é—­åŸåˆ™** - å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
3. **ä¾èµ–å€’ç½®** - ä¾èµ–æŠ½è±¡ï¼ˆåŸºç±»ï¼‰ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
4. **å•ä¸€èŒè´£** - æ¯ä¸ªåŸºç±»åªè´Ÿè´£ä¸€ä»¶äº‹

### ä½¿ç”¨è¦ç‚¹

```python
# 1. æ¨¡å‹å¿…é¡»ç»§æ‰¿ CoreModel
class Book(CoreModel):
    title = models.CharField(...)

# 2. åºåˆ—åŒ–å™¨å¿…é¡»ç»§æ‰¿ CustomModelSerializer
class BookSerializer(CustomModelSerializer):
    class Meta:
        model = Book
        fields = '__all__'

# 3. è§†å›¾é›†å¿…é¡»ç»§æ‰¿ CustomModelViewSet
class BookViewSet(CustomModelViewSet):
    queryset = Book.objects.all()
    serializer_class = BookSerializer
```

---

## é™„å½•

### A. å¸¸è§é—®é¢˜

**Q1: ä¸ºä»€ä¹ˆè¦ç»§æ‰¿è¿™äº›åŸºç±»ï¼Ÿ**
A: ç»§æ‰¿åŸºç±»å¯ä»¥è‡ªåŠ¨è·å¾—å®Œæ•´çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å®¡è®¡å­—æ®µã€æƒé™æ§åˆ¶ã€ç»Ÿä¸€å“åº”ç­‰ï¼Œé¿å…é‡å¤å¼€å‘ã€‚

**Q2: å¯ä»¥ä¸ç»§æ‰¿è¿™äº›åŸºç±»å—ï¼Ÿ**
A: å¯ä»¥ï¼Œä½†ä¼šå¤±å»å¾ˆå¤šåŠŸèƒ½ï¼Œéœ€è¦è‡ªå·±å®ç°å®¡è®¡ã€æƒé™ã€å“åº”æ ¼å¼ç­‰ã€‚

**Q3: å¦‚ä½•è¦†ç›–åŸºç±»æ–¹æ³•ï¼Ÿ**
A: ç›´æ¥åœ¨å­ç±»ä¸­é‡å†™æ–¹æ³•å³å¯ï¼Œå¦‚ `def create(self, request, *args, **kwargs):`

**Q4: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰å­—æ®µï¼Ÿ**
A: åœ¨åºåˆ—åŒ–å™¨ä¸­æ·»åŠ  `SerializerMethodField` æˆ– `CharField(source='...')`

**Q5: å¦‚ä½•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼Ÿ**
A: ä½¿ç”¨ `select_related` å’Œ `prefetch_related` ä¼˜åŒ–å…³è”æŸ¥è¯¢

### B. å‚è€ƒèµ„æº

- [Django å®˜æ–¹æ–‡æ¡£](https://docs.djangoproject.com/zh-hans/)
- [DRF å®˜æ–¹æ–‡æ¡£](https://www.django-rest-framework.org/)
- [DVAdmin å®˜æ–¹æ–‡æ¡£](https://django-vue-admin.com)
- [DVAdmin æºç ](https://gitee.com/huge-dream/django-vue3-admin)

---

**æ–‡æ¡£ç‰ˆæœ¬:** v1.0.0
**æœ€åæ›´æ–°:** 2024-01-25
**ç»´æŠ¤è€…:** Claude AI

å¦‚æœ‰ç–‘é—®ï¼Œè¯·æŸ¥é˜…å®˜æ–¹æ–‡æ¡£æˆ–åŠ å…¥ç¤¾åŒºè®¨è®ºã€‚
