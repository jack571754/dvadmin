# DVAdmin 后端架构设计篇

> **文档定位**：面向开发者，深入解析架构原理与设计模式
> **更新时间**：2026-01-24
> **适用版本**：Django 4.2.14 + DRF 3.15.2

---

## 目录

- [1. 架构概览](#1-架构概览)
- [2. 分层架构设计](#2-分层架构设计)
- [3. 核心组件](#3-核心组件)
- [4. 请求处理流程](#4-请求处理流程)
- [5. 数据模型设计](#5-数据模型设计)
- [6. 权限系统架构](#6-权限系统架构)
- [7. WebSocket 架构](#7-websocket-架构)
- [8. 设计模式总结](#8-设计模式总结)

---

## 1. 架构概览

### 1.1 架构定位

DVAdmin 采用 **前后端分离 + RBAC 权限模型** 的企业级开发框架，核心特点是**列级别的权限控制**。

### 1.2 技术栈

| 层次 | 技术 |
|------|------|
| **Web 框架** | Django 4.2.14 |
| **API 框架** | Django REST Framework 3.15.2 |
| **认证** | JWT (djangorestframework_simplejwt 5.4.0) |
| **文档** | drf-yasg 1.21.7 (Swagger) |
| **WebSocket** | channels 4.1.0 |
| **数据库** | SQLite3 (默认) / MySQL 8.0+ / PostgreSQL |
| **异步任务** | dvadmin3-celery 3.1.6 |

### 1.3 整体架构图

```mermaid
graph TB
    subgraph "客户端层"
        A1["Vue3 前端应用"]
        A2["Swagger API 文档"]
        A3["WebSocket 客户端"]
    end

    subgraph "接入层"
        B1["Uvicorn ASGI 服务器"]
        B2["CORS 中间件"]
        B3["认证中间件"]
    end

    subgraph "路由层"
        C1["urls.py - 主路由"]
        C2["API 路由分发"]
        C3["WebSocket 路由"]
    end

    subgraph "视图层 (ViewSet)"
        D1["CustomModelViewSet<br/>基类"]
        D2["业务 ViewSet"]
        D3["登录/登出视图"]
    end

    subgraph "业务逻辑层"
        E1["权限验证"]
        E2["数据过滤"]
        E3["序列化处理"]
    end

    subgraph "数据访问层"
        F1["CoreModel 基类"]
        F2["QuerySet 过滤器"]
        F3["ORM 操作"]
    end

    subgraph "数据存储层"
        G1[(MySQL/PostgreSQL)]
        G2[(SQLite3)]
        G3[(Redis - 可选)]
    end

    A1 --> B1
    A2 --> B1
    A3 --> B1
    B1 --> B2
    B2 --> B3
    B3 --> C1
    C1 --> C2
    C1 --> C3
    C2 --> D1
    C3 --> D3
    D1 --> D2
    D2 --> E1
    E1 --> E2
    E2 --> E3
    E3 --> F1
    F1 --> F2
    F2 --> F3
    F3 --> G1
    F3 --> G2
    F3 --> G3
```

---

## 2. 分层架构设计

### 2.1 架构层次

```
┌─────────────────────────────────────────────────────────────┐
│                         表现层 (Presentation)                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  API 接口    │  │  Swagger     │  │  WebSocket   │       │
│  │  (ViewSet)   │  │  文档        │  │  (Consumer)  │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
├─────────────────────────────────────────────────────────────┤
│                         业务逻辑层 (Business)                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  权限验证    │  │  数据过滤    │  │  序列化处理   │       │
│  │  Permission  │  │  Filter      │  │  Serializer  │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
├─────────────────────────────────────────────────────────────┤
│                         数据访问层 (Data Access)             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  CoreModel   │  │  Manager     │  │  QuerySet    │       │
│  │  基类        │  │  管理器      │  │  查询集      │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
├─────────────────────────────────────────────────────────────┤
│                         持久化层 (Persistence)               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   MySQL      │  │  PostgreSQL  │  │   SQLite     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 目录映射

| 分层 | 目录 | 说明 |
|------|------|------|
| 表现层 | `dvadmin/*/views/` | ViewSet 视图层 |
| 业务逻辑层 | `dvadmin/utils/` | 权限、过滤器、序列化器 |
| 数据访问层 | `dvadmin/*/models.py` | 数据模型 |
| 持久化层 | `DATABASES` 配置 | 数据库 |

---

## 3. 核心组件

### 3.1 CoreModel - 核心基类

**位置**：`dvadmin/utils/models.py`

**设计原理**：抽象基类模式，为所有业务模型提供统一的审计字段和功能。

```python
class CoreModel(models.Model):
    # 主键
    id = models.BigAutoField(primary_key=True)

    # 审计字段
    creator = models.ForeignKey(...)      # 创建人
    modifier = models.CharField(...)      # 修改人
    dept_belong_id = models.CharField(...) # 数据归属部门
    create_datetime = models.DateTimeField(auto_now_add=True)
    update_datetime = models.DateTimeField(auto_now=True)

    # 自定义 Manager
    objects = CoreModelManager()

    class Meta:
        abstract = True  # 抽象基类，不生成表
```

**核心功能**：
1. 自动审计字段（创建人、修改人、时间戳）
2. 数据归属部门支持（用于数据权限）
3. 软删除支持（通过 `SoftDeleteModel`）
4. 自定义 Manager 拦截查询操作

### 3.2 CustomModelViewSet - 视图集基类

**位置**：`dvadmin/utils/viewset.py`

**设计原理**：模板方法模式 + DRF 的 ModelViewSet，封装 CRUD 标准操作。

```python
class CustomModelViewSet(ModelViewSet):
    # 序列化器配置
    serializer_class = None
    create_serializer_class = None      # 创建时使用
    update_serializer_class = None      # 更新时使用
    list_serializer_class = None        # 列表时使用

    # 过滤配置
    filter_fields = '__all__'           # 支持全部字段过滤
    search_fields = ()

    # 权限配置
    permission_classes = [CustomPermission]

    # 导入导出
    import_field_dict = {}
    export_field_label = {}
```

**核心方法流程**：

```mermaid
flowchart TD
    A[请求进入] --> B{获取序列化器}
    B --> C{action 类型?}
    C -->|create| D[create_serializer_class]
    C -->|update| E[update_serializer_class]
    C -->|list| F[list_serializer_class]
    C -->|其他| G[serializer_class]

    D --> H[get_menu_field<br/>获取字段权限]
    E --> H
    F --> H
    G --> H

    H --> I[过滤未授权字段]
    I --> J[执行业务逻辑]
    J --> K[返回响应]
```

### 3.3 CustomPermission - 权限类

**位置**：`dvadmin/utils/permission.py`

**设计原理**：基于 RBAC 的接口权限验证。

```python
class CustomPermission(BasePermission):
    def has_permission(self, request, view):
        # 1. 超级管理员直接通过
        if request.user.is_superuser:
            return True

        # 2. 检查接口白名单
        api = request.path
        method = request.method
        if api in white_list:
            return True

        # 3. 检查角色权限
        role_id_list = request.user.role.values_list('id', flat=True)
        user_api_list = RoleMenuButtonPermission.objects.filter(
            role__in=role_id_list
        ).values('permission__api', 'permission__method')

        # 4. 正则匹配接口权限
        return validate_api(api, method, user_api_list)
```

### 3.4 CoreModelFilterBackend - 过滤器

**设计原理**：动态字段过滤，支持所有模型字段。

```python
class CoreModelFilterBackend(FilterSet):
    """
    根据 model 字段动态生成过滤器
    filter_fields = '__all__' 支持全部字段
    """
```

### 3.5 DataLevelPermissionMargeFilter - 数据权限过滤器

**设计原理**：根据角色数据权限范围过滤查询集。

```python
class DataLevelPermissionMargeFilter:
    def filter_queryset(self, request, queryset, view):
        """
        数据权限范围：
        0 - 仅本人数据
        1 - 本部门及以下
        2 - 本部门数据
        3 - 全部数据
        4 - 自定义部门
        """
        # 获取用户当前角色的数据权限范围
        data_range = get_user_data_range(request.user)

        if data_range == 0:  # 仅本人
            return queryset.filter(creator=request.user)
        elif data_range == 1:  # 本部门及以下
            dept_ids = Dept.recursion_all_dept(request.user.dept_id)
            return queryset.filter(dept_belong_id__in=dept_ids)
        # ...
```

---

## 4. 请求处理流程

### 4.1 完整请求流程

```mermaid
sequenceDiagram
    participant C as 客户端
    participant M as 中间件层
    participant R as 路由层
    participant P as 权限验证
    participant V as ViewSet
    participant S as Serializer
    participant F as Filter
    participant DB as 数据库

    C->>M: HTTP Request
    M->>M: 1. HealthCheckMiddleware
    M->>M: 2. CorsMiddleware
    M->>M: 3. AuthenticationMiddleware
    M->>M: 4. ApiLoggingMiddleware
    M->>R: 5. URL Routing

    R->>P: 6. 权限检查
    P->>P: has_permission()
    P->>P: 检查 API 白名单
    P->>P: 检查角色接口权限

    alt 权限验证失败
        P-->>C: 403 Forbidden
    else 权限验证通过
        P->>V: 7. 进入 ViewSet
        V->>F: 8. filter_queryset()
        F->>F: 数据权限过滤
        F->>F: 字段过滤
        F->>DB: 9. ORM Query
        DB-->>F: 10. QuerySet
        F-->>V: 11. Filtered QuerySet

        V->>S: 12. get_serializer()
        S->>S: get_menu_field()
        S->>S: 字段权限过滤
        S-->>V: 13. Serializer

        V->>S: 14. serializer.data
        S-->>V: 15. 序列化数据
        V-->>C: 16. SuccessResponse
    end
```

### 4.2 中间件执行顺序

**位置**：`application/settings.py`

```python
MIDDLEWARE = [
    "dvadmin.utils.middleware.HealthCheckMiddleware",    # 1. 健康检查
    "django.middleware.security.SecurityMiddleware",     # 2. 安全
    "whitenoise.middleware.WhiteNoiseMiddleware",        # 3. 静态文件
    "django.contrib.sessions.middleware.SessionMiddleware",  # 4. Session
    "corsheaders.middleware.CorsMiddleware",             # 5. CORS 跨域
    "django.middleware.common.CommonMiddleware",         # 6. 通用
    "django.middleware.csrf.CsrfViewMiddleware",         # 7. CSRF
    "django.contrib.auth.middleware.AuthenticationMiddleware", # 8. 认证
    "django.contrib.messages.middleware.MessageMiddleware", # 9. 消息
    "django.middleware.clickjacking.XFrameOptionsMiddleware", # 10. 点击劫持
    "dvadmin.utils.middleware.ApiLoggingMiddleware",     # 11. API 日志
]
```

### 4.3 认证流程

```mermaid
flowchart LR
    A[用户登录] --> B[POST /api/login/]
    B --> C{验证码校验}
    C -->|失败| D[返回验证码错误]
    C -->|成功| E[CustomBackend.authenticate]
    E --> F{用户存在?}
    F -->|否| D
    F -->|是| G{密码正确?}
    G -->|否| H[记录登录失败]
    G -->|是| I[生成 JWT Token]
    I --> J[记录登录日志]
    J --> K[返回 Token + 用户信息]
```

---

## 5. 数据模型设计

### 5.1 核心模型关系

```mermaid
erDiagram
    Users ||--o{ Role : "多对多"
    Users ||--o{ Post : "多对多"
    Users }o--|| Dept : "所属部门"
    Users ||--o{ Dept : "管理部门"

    Role ||--o{ Menu : "菜单权限"
    Role ||--o{ MenuButton : "按钮权限"
    Role ||--o{ FieldPermission : "字段权限"

    Menu ||--o{ Menu : "父子菜单"
    Menu ||--o{ MenuButton : "按钮"
    Menu ||--o{ MenuField : "字段定义"

    MenuField ||--o{ FieldPermission : "字段权限关联"

    Role ||--o{ RoleMenuButtonPermission : "按钮权限配置"

    Users {
        BigAutoField id PK
        string username UK
        string email
        string mobile
        string name
        integer gender
        integer user_type
        datetime create_datetime
        datetime update_datetime
    }

    Role {
        BigAutoField id PK
        string name
        string key UK
        integer sort
        boolean status
    }

    Dept {
        BigAutoField id PK
        string name
        string key UK
        integer sort
        BigAutoField parent_id FK
    }

    Menu {
        BigAutoField id PK
        string name
        string web_path
        string component
        BigAutoField parent_id FK
        boolean status
    }

    MenuButton {
        BigAutoField id PK
        string name
        string value UK
        string api
        integer method
    }

    FieldPermission {
        BigAutoField id PK
        BigAutoField role_id FK
        BigAutoField field_id FK
        boolean is_query
        boolean is_create
        boolean is_update
    }
```

### 5.2 模型继承体系

```mermaid
classDiagram
    class Model {
        <<Django Base>>
        +save()
        +delete()
    }

    class SoftDeleteModel {
        <<软删除>>
        +is_deleted
        +delete(soft_delete)
    }

    class CoreModel {
        <<核心基类>>
        +id: BigAutoField
        +creator: ForeignKey
        +modifier: CharField
        +dept_belong_id: CharField
        +create_datetime: DateTimeField
        +update_datetime: DateTimeField
        +objects: CoreModelManager
    }

    class Users {
        +username: CharField
        +email: EmailField
        +mobile: CharField
        +role: ManyToMany
        +dept: ForeignKey
    }

    class Role {
        +name: CharField
        +key: CharField
        +status: BooleanField
    }

    class Menu {
        +name: CharField
        +web_path: CharField
        +component: CharField
        +parent: ForeignKey
    }

    Model <|-- SoftDeleteModel
    SoftDeleteModel <|-- CoreModel
    CoreModel <|-- Users
    CoreModel <|-- Role
    CoreModel <|-- Menu
```

### 5.3 关键设计特点

1. **统一审计字段**
   - 所有业务模型继承 `CoreModel`
   - 自动记录创建人、修改人、时间戳
   - 支持 `request` 参数自动注入用户信息

2. **软删除支持**
   - 通过 `SoftDeleteModel` 实现
   - 删除时设置 `is_deleted=True`
   - 查询时自动过滤已删除数据

3. **数据归属**
   - `dept_belong_id` 字段记录数据归属部门
   - 用于数据权限过滤

4. **表前缀**
   - 统一使用 `TABLE_PREFIX` 配置
   - 默认：`dvadmin_`

---

## 6. 权限系统架构

### 6.1 RBAC 权限模型

DVAdmin 实现**增强型 RBAC**，支持三级权限控制：

```mermaid
graph TD
    A["RBAC 权限模型"] --> B["菜单权限"]
    A --> C["按钮权限"]
    A --> D["数据权限"]
    A --> E["字段权限"]

    B --> B1["控制页面访问"]
    B --> B2["控制菜单显示"]

    C --> C1["控制接口调用"]
    C --> C2["控制按钮显示"]

    D --> D1["全部数据"]
    D --> D2["本部门数据"]
    D --> D3["本部门及以下"]
    D --> D4["仅本人数据"]
    D --> D5["自定义部门"]

    E --> E1["字段查询权限"]
    E --> E2["字段创建权限"]
    E --> E3["字段更新权限"]
```

### 6.2 权限验证流程

```mermaid
flowchart TD
    A[API 请求] --> B{用户认证}
    B -->|失败| C[401 Unauthorized]
    B -->|成功| D{超级管理员?}
    D -->|是| E[允许访问]
    D -->|否| F{接口白名单?}
    F -->|是| E
    F -->|否| G{角色有权限?}
    G -->|是| H{数据权限过滤}
    G -->|否| I[403 Forbidden]
    H --> J[QuerySet 过滤]
    J --> K{字段权限}
    K --> L[返回过滤后数据]
```

### 6.3 权限配置数据结构

**角色菜单按钮权限表** (`RoleMenuButtonPermission`)：

| 字段 | 类型 | 说明 |
|------|------|------|
| role | ForeignKey | 关联角色 |
| menu_button | ForeignKey | 关联按钮 |
| data_range | Integer | 数据权限范围 (0-4) |
| dept | ManyToMany | 自定义部门列表 (data_range=4) |

---

## 7. WebSocket 架构

### 7.1 ASGI 配置

**位置**：`application/asgi.py`

```python
application = ProtocolTypeRouter({
    "http": http_application,           # HTTP 请求
    "websocket": AuthMiddlewareStack(   # WebSocket 请求
        URLRouter(websocket_urlpatterns)
    ),
})
```

### 7.2 WebSocket 路由

**位置**：`application/ws_routing.py`

```python
websocket_urlpatterns = [
    re_path(r'^ws/(?P<token>.+)/', MegCenter.as_asgi()),
]
```

### 7.3 消息推送流程

```mermaid
sequenceDiagram
    participant F as 前端
    participant W as WebSocket Consumer
    participant C as Channel Layer
    participant DB as 数据库

    F->>W: 1. WebSocket 连接 /ws/{token}/
    W->>W: 2. 解析 token 获取 user_id
    W->>C: 3. 加入 channel: user_{user_id}
    C-->>F: 4. 连接成功

    Note over DB: 后台业务逻辑
    DB->>C: 5. 发送消息到 user_{user_id}
    C->>W: 6. 转发消息
    W->>F: 7. 推送到前端
```

---

## 8. 设计模式总结

### 8.1 使用的设计模式

| 模式 | 应用位置 | 说明 |
|------|----------|------|
| **抽象工厂** | CoreModel | 抽象基类，提供统一接口 |
| **模板方法** | CustomModelViewSet | 定义 CRUD 流程骨架 |
| **策略模式** | Filter Backend | 可插拔的过滤策略 |
| **装饰器模式** | permission_classes | 动态添加权限验证 |
| **中间件模式** | Middleware | 请求/响应处理链 |
| **单例模式** | settings.DICTIONARY_CONFIG | 全局配置缓存 |
| **观察者模式** | Django Signals | 模型变更通知 |
| **责任链模式** | Middleware Pipeline | 请求处理链 |

### 8.2 架构优势

1. **高度封装**
   - `CustomModelViewSet` 封装 80% CRUD 代码
   - 继承即可获得完整功能

2. **权限粒度细**
   - 菜单、按钮、数据、字段四级权限
   - 列级别权限控制（行业首创）

3. **扩展性强**
   - 插件化架构
   - 自定义 ViewSet 无缝集成

4. **开发效率高**
   - 标准化目录结构
   - 代码生成友好

### 8.3 架构权衡

| 优势 | 代价 |
|------|------|
| 封装程度高 | 灵活性降低，深度定制需修改基类 |
| 约定优于配置 | 学习曲线，需理解框架约定 |
| 权限粒度细 | 性能开销，多次数据库查询 |

---

**下一篇**：[02_开发指南篇.md](./02_开发指南篇.md) - 从 0 到 1 开发业务模块

**相关文档**：
- [03_权限系统篇.md](./03_权限系统篇.md)
- [04_实战案例_商品管理模块.md](./04_实战案例_商品管理模块.md)
