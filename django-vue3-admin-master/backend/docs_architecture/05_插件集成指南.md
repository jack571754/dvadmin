# DVAdmin 插件集成指南

> **文档定位**：插件开发与集成完整教程
> **更新时间**：2026-01-24

---

## 目录

- [1. 插件系统概览](#1-插件系统概览)
- [2. 插件目录结构](#2-插件目录结构)
- [3. 插件开发规范](#3-插件开发规范)
- [4. 插件配置](#4-插件配置)
- [5. 现有插件集成](#5-现有插件集成)
- [6. 插件开发实战](#6-插件开发实战)

---

## 1. 插件系统概览

### 1.1 插件系统原理

DVAdmin 的插件系统基于 **Python 动态模块加载**，通过以下机制实现：

```python
# application/settings.py
PLUGINS_PATH = os.path.join(BASE_DIR, "plugins")
sys.path.insert(0, PLUGINS_PATH)

# 自动加载 plugins/ 下所有子目录
[
    sys.path.insert(0, os.path.join(PLUGINS_PATH, ele))
    for ele in os.listdir(PLUGINS_PATH)
    if os.path.isdir(os.path.join(PLUGINS_PATH, ele)) and not ele.startswith("__")
]
```

### 1.2 插件类型

| 类型 | 说明 | 示例 |
|------|------|------|
| **后端插件** | Django App 扩展 | dvadmin-celery、dvadmin-apscheduler |
| **前端插件** | Vue 组件扩展 | uniapp 插件 |
| **混合插件** | 前后端结合 | 审批流程插件 |

---

## 2. 插件目录结构

### 2.1 标准插件结构

```
plugins/
├── __init__.py
├── dvadmin-[plugin-name]/           # 插件目录
│   ├── __init__.py
│   ├── README.md                    # 插件说明
│   ├── pyproject.toml               # 项目配置（新版）
│   ├── setup.py                     # 安装配置（传统）
│   ├── [plugin_name]/               # Django App
│   │   ├── __init__.py
│   │   ├── apps.py                  # App 配置
│   │   ├── models.py                # 数据模型
│   │   ├── views/                   # 视图层
│   │   ├── serializers.py           # 序列化器
│   │   ├── urls.py                  # 路由配置
│   │   └── ...
│   └── settings.py                  # 插件配置（可选）
└── ...
```

### 2.2 插件目录映射

```python
# 插件会被自动添加到 Python 路径
# plugins/dvadmin-celery/celery_app/
# 可以直接导入：from celery_app.models import Task
```

---

## 3. 插件开发规范

### 3.1 pyproject.toml 配置

```toml
[project]
name = "dvadmin-myservice"
version = "1.0.0"
description = "DVAdmin 我的服务插件"
authors = [
    {name = "Your Name", email = "your@email.com"}
]
readme = "README.md"
requires-python = ">=3.9"
dependencies = [
    "django>=4.2",
    "djangorestframework>=3.14",
]

[build-system]
requires = ["setuptools>=61.0"]
build-backend = "setuptools.build_meta"

[project.urls]
Homepage = "https://github.com/your/dvadmin-myservice"
Documentation = "https://your-docs.com"
```

### 3.2 setup.py 配置（传统方式）

```python
from setuptools import setup, find_packages

setup(
    name="dvadmin-myservice",
    version="1.0.0",
    description="DVAdmin 我的服务插件",
    author="Your Name",
    author_email="your@email.com",
    packages=find_packages(),
    install_requires=[
        "django>=4.2",
        "djangorestframework>=3.14",
    ],
    include_package_data=True,
)
```

### 3.3 插件 App 配置

```python
# myservice/apps.py
from django.apps import AppConfig


class MyserviceConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'myservice'  # 必须与目录名一致
    verbose_name = '我的服务'

    def ready(self):
        """
        App 启动时执行
        可以在这里注册信号、初始化配置等
        """
        pass
```

---

## 4. 插件配置

### 4.1 注册插件到系统

**方式 1：直接添加到 INSTALLED_APPS**

```python
# application/settings.py

INSTALLED_APPS = [
    # ...
    "dvadmin.system",
    "myservice",  # 添加插件
]
```

**方式 2：动态导入插件配置**

```python
# application/settings.py

# 一键导入插件配置
from dvadmin3_celery.settings import *        # celery 异步任务
# from dvadmin_tenants.settings import *      # 租户管理
# from dvadmin_social_auth.settings import *  # 社交登录
```

### 4.2 插件路由注册

```python
# myservice/urls.py
from django.urls import path, include
from rest_framework.routers import SimpleRouter
from .views import MyServiceViewSet

router = SimpleRouter()
router.register(r'myservice', MyServiceViewSet)

urlpatterns = [
    path('', include(router.urls)),
]
```

```python
# application/urls.py
urlpatterns += [
    path('api/myservice/', include('myservice.urls')),
]
```

---

## 5. 现有插件集成

### 5.1 dvadmin-celery（异步任务）

**安装**：

```bash
pip install dvadmin3-celery
```

**配置**：

```python
# application/settings.py
from dvadmin3_celery.settings import *

INSTALLED_APPS += [
    'django_celery_beat',
    'dvadmin3_celery',
]
```

**数据库迁移**：

```bash
python manage.py migrate
```

### 5.2 dvadmin-apscheduler（定时任务）

**安装**：

```bash
pip install django-apscheduler
```

**配置**：

```python
# application/settings.py
INSTALLED_APPS += [
    'apscheduler',
]
```

### 5.3 审批流程插件（dvadmin_approval）

**位置**：`E:\project\dvadmin\dvadmin_approval\`

**集成步骤**：

```python
# 1. 添加到 INSTALLED_APPS
INSTALLED_APPS = [
    # ...
    "dvadmin_approval",
]

# 2. 注册路由
urlpatterns += [
    path('api/workflow/', include('dvadmin_approval.urls')),
]

# 3. 数据库迁移
python manage.py makemigrations dvadmin_approval
python manage.py migrate dvadmin_approval
```

---

## 6. 插件开发实战

### 6.1 创建一个通知插件

**需求**：实现简单的站内通知功能

**步骤 1：创建插件目录**

```bash
cd backend/plugins
mkdir dvadmin-notification
cd dvadmin-notification
```

**步骤 2：创建配置文件**

```bash
# pyproject.toml
[project]
name = "dvadmin-notification"
version = "1.0.0"
description = "DVAdmin 通知插件"
dependencies = [
    "django>=4.2",
]
```

**步骤 3：创建 Django App**

```
dvadmin-notification/
├── __init__.py
├── notification/
│   ├── __init__.py
│   ├── apps.py
│   ├── models.py
│   ├── views/
│   │   └── notification.py
│   ├── serializers.py
│   └── urls.py
└── settings.py
```

**步骤 4：定义模型**

```python
# notification/models.py
from dvadmin.utils.models import CoreModel, table_prefix

class Notification(CoreModel):
    """站内通知"""
    title = models.CharField(max_length=128, verbose_name="标题")
    content = models.TextField(verbose_name="内容")
    is_read = models.BooleanField(default=False, verbose_name="是否已读")
    target_user = models.ForeignKey(
        to='system.Users',
        on_delete=models.CASCADE,
        verbose_name="目标用户"
    )

    class Meta:
        db_table = table_prefix + "notification"
        verbose_name = "站内通知"
```

**步骤 5：创建视图集**

```python
# notification/views/notification.py
from dvadmin.utils.viewset import CustomModelViewSet
from ..models import Notification
from ..serializers import NotificationSerializer

class NotificationViewSet(CustomModelViewSet):
    queryset = Notification.objects.all()
    serializer_class = NotificationSerializer
```

**步骤 6：注册插件**

```python
# application/settings.py
INSTALLED_APPS = [
    # ...
    "notification",  # 通知插件
]

# application/urls.py
urlpatterns += [
    path('api/notification/', include('notification.urls')),
]
```

**步骤 7：执行迁移**

```bash
python manage.py makemigrations notification
python manage.py migrate notification
```

---

## 7. 插件发布

### 7.1 发布到 PyPI

```bash
# 1. 构建发布包
pip install build
python -m build

# 2. 发布到 PyPI
pip install twine
twine upload dist/*
```

### 7.2 本地安装

```bash
# 开发模式安装（可编辑）
pip install -e plugins/dvadmin-notification

# 或从本地安装
pip install plugins/dvadmin-notification/
```

---

## 8. 调试技巧

### 8.1 查看插件加载状态

```python
# python manage.py shell
>>> import sys
>>> for p in sys.path:
...     if 'plugins' in p:
...         print(p)
```

### 8.2 检查插件路由

```bash
python manage.py show_urls | grep notification
```

---

## 9. 常见问题

### 9.1 插件未加载

**问题**：插件安装后无法使用

**解决**：
1. 检查插件是否在 `plugins/` 目录下
2. 检查 `INSTALLED_APPS` 是否包含
3. 重启服务器

### 9.2 导入错误

**问题**：`ModuleNotFoundError: No module named 'xxx'`

**解决**：
```python
# 检查 sys.path
import sys
print(sys.path)

# 确保插件目录已添加
import os
PLUGINS_PATH = os.path.join(BASE_DIR, "plugins")
sys.path.insert(0, PLUGINS_PATH)
```

---

## 10. 参考资源

- [官方插件开发文档](https://bbs.django-vue-admin.com/article/4.html)
- [插件市场](https://bbs.django-vue-admin.com/plugMarket.html)
- [dvadmin-celery 源码](https://gitee.com/devil-ryu/dvadmin-celery)
- [二次开发论坛](https://bbs.django-vue-admin.com/tag/54.html)

---

**相关文档**：
- [01_架构设计篇.md](./01_架构设计篇.md)
- [02_开发指南篇.md](./02_开发指南篇.md)
    