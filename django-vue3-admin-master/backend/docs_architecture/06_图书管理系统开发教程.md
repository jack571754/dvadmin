# DVAdmin å®Œæ•´å¼€å‘æ•™ç¨‹ - å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ

> ä½œè€…: Claude AI
> åˆ›å»ºæ—¶é—´: 2024-01-25
> é€‚ç”¨ç‰ˆæœ¬: DVAdmin 3.x
> éš¾åº¦çº§åˆ«: â­â­â­ (ä¸­çº§)

---

## ğŸ“– æ•™ç¨‹è¯´æ˜

æœ¬æ•™ç¨‹é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ Demoï¼Œå¸¦ä½ æ·±å…¥äº†è§£ DVAdmin æ¡†æ¶çš„å®Œæ•´å¼€å‘æµç¨‹ã€‚**ä¸ç¼–è¾‘ä»»ä½•ä»£ç **ï¼Œä»…å±•ç¤ºå®Œæ•´å¼€å‘é“¾è·¯ï¼Œè®©ä½ ç†è§£ä»é›¶åˆ°ä¸Šçº¿çš„å…¨éƒ¨è¿‡ç¨‹ã€‚

### å­¦ä¹ ç›®æ ‡

- âœ… ç†è§£ DVAdmin çš„å®Œæ•´å¼€å‘æµç¨‹
- âœ… æŒæ¡æ¨¡å‹ã€åºåˆ—åŒ–å™¨ã€è§†å›¾é›†çš„åˆ›å»º
- âœ… ç†è§£è·¯ç”±é…ç½®å’Œæƒé™ç³»ç»Ÿ
- âœ… å­¦ä¼šæµ‹è¯• API æ¥å£

### é¡¹ç›®åŠŸèƒ½

- ğŸ“š å›¾ä¹¦ç®¡ç†ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
- ğŸ“– åˆ†ç±»ç®¡ç†ï¼ˆæ ‘å½¢ç»“æ„ï¼‰
- ğŸ‘¤ ä½œè€…ç®¡ç†
- ğŸ” å€Ÿé˜…è®°å½•ï¼ˆå«å½’è¿˜åŠŸèƒ½ï¼‰

---

## ğŸ“‹ ç›®å½•

- [ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ•°æ®æ¨¡å‹](#ç¬¬ä¸€æ­¥åˆ›å»ºæ•°æ®æ¨¡å‹)
- [ç¬¬äºŒæ­¥ï¼šåˆ›å»ºåºåˆ—åŒ–å™¨](#ç¬¬äºŒæ­¥åˆ›å»ºåºåˆ—åŒ–å™¨)
- [ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºè§†å›¾é›†](#ç¬¬ä¸‰æ­¥åˆ›å»ºè§†å›¾é›†)
- [ç¬¬å››æ­¥ï¼šé…ç½®è·¯ç”±](#ç¬¬å››æ­¥é…ç½®è·¯ç”±)
- [ç¬¬äº”æ­¥ï¼šæ•°æ®åº“è¿ç§»](#ç¬¬äº”æ­¥æ•°æ®åº“è¿ç§»)
- [ç¬¬å…­æ­¥ï¼šæƒé™å’Œèœå•é…ç½®](#ç¬¬å…­æ­¥æƒé™å’Œèœå•é…ç½®)
- [ç¬¬ä¸ƒæ­¥ï¼šæµ‹è¯• API æ¥å£](#ç¬¬ä¸ƒæ­¥æµ‹è¯•-api-æ¥å£)
- [å®Œæ•´å¼€å‘æµç¨‹å›¾](#å®Œæ•´å¼€å‘æµç¨‹å›¾)
- [å…³é”®é…ç½®è¯´æ˜](#å…³é”®é…ç½®è¯´æ˜)

---

## ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ•°æ®æ¨¡å‹

### 1.1 æ¨¡å‹è®¾è®¡

**æ–‡ä»¶ä½ç½®:** `backend/dvadmin/system/models.py`

```python
from django.db import models
from dvadmin.utils.models import CoreModel


class BookCategory(CoreModel):
    """
    å›¾ä¹¦åˆ†ç±»æ¨¡å‹
    """
    name = models.CharField(max_length=50, verbose_name="åˆ†ç±»åç§°")
    code = models.CharField(max_length=20, unique=True, verbose_name="åˆ†ç±»ç¼–ç ")
    description = models.TextField(blank=True, null=True, verbose_name="åˆ†ç±»æè¿°")
    parent = models.ForeignKey(
        'self',
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        verbose_name="çˆ¶åˆ†ç±»"
    )

    class Meta:
        db_table = 'dvadmin_book_category'
        verbose_name = 'å›¾ä¹¦åˆ†ç±»'
        verbose_name_plural = verbose_name

    def __str__(self):
        return self.name


class BookAuthor(CoreModel):
    """
    ä½œè€…æ¨¡å‹
    """
    name = models.CharField(max_length=50, verbose_name="ä½œè€…å§“å")
    gender = models.CharField(
        max_length=10,
        choices=(('male', 'ç”·'), ('female', 'å¥³')),
        verbose_name="æ€§åˆ«"
    )
    birth_date = models.DateField(verbose_name="å‡ºç”Ÿæ—¥æœŸ")
    country = models.CharField(max_length=50, verbose_name="å›½ç±")
    biography = models.TextField(blank=True, null=True, verbose_name="ä½œè€…ç®€ä»‹")

    class Meta:
        db_table = 'dvadmin_book_author'
        verbose_name = 'å›¾ä¹¦ä½œè€…'
        verbose_name_plural = verbose_name

    def __str__(self):
        return self.name


class Book(CoreModel):
    """
    å›¾ä¹¦æ¨¡å‹ï¼ˆæ ¸å¿ƒæ¨¡å‹ï¼‰
    """
    # åŸºæœ¬ä¿¡æ¯
    title = models.CharField(max_length=200, verbose_name="ä¹¦å")
    subtitle = models.CharField(max_length=200, blank=True, verbose_name="å‰¯æ ‡é¢˜")
    isbn = models.CharField(max_length=13, unique=True, verbose_name="ISBN")

    # å…³è”ä¿¡æ¯
    category = models.ForeignKey(
        BookCategory,
        on_delete=models.PROTECT,
        verbose_name="åˆ†ç±»",
        related_name="books"
    )
    author = models.ForeignKey(
        BookAuthor,
        on_delete=models.PROTECT,
        verbose_name="ä½œè€…",
        related_name="books"
    )

    # å‡ºç‰ˆä¿¡æ¯
    publisher = models.CharField(max_length=100, verbose_name="å‡ºç‰ˆç¤¾")
    publish_date = models.DateField(verbose_name="å‡ºç‰ˆæ—¥æœŸ")
    price = models.DecimalField(max_digits=10, decimal_places=2, verbose_name="ä»·æ ¼")

    # åº“å­˜ä¿¡æ¯
    stock = models.IntegerField(default=0, verbose_name="åº“å­˜æ•°é‡")
    location = models.CharField(max_length=50, verbose_name="ä¹¦æ¶ä½ç½®")

    # å…¶ä»–ä¿¡æ¯
    pages = models.IntegerField(blank=True, null=True, verbose_name="é¡µæ•°")
    language = models.CharField(max_length=20, default='ä¸­æ–‡', verbose_name="è¯­è¨€")
    description = models.TextField(blank=True, null=True, verbose_name="å†…å®¹ç®€ä»‹")
    cover_image = models.ImageField(upload_to='book_covers/', blank=True, verbose_name="å°é¢å›¾ç‰‡")

    # çŠ¶æ€
    is_available = models.BooleanField(default=True, verbose_name="æ˜¯å¦å¯å€Ÿ")

    class Meta:
        db_table = 'dvadmin_book'
        verbose_name = 'å›¾ä¹¦ä¿¡æ¯'
        verbose_name_plural = verbose_name
        ordering = ['-create_time']

    def __str__(self):
        return f"{self.title} ({self.isbn})"


class BorrowRecord(CoreModel):
    """
    å€Ÿé˜…è®°å½•æ¨¡å‹
    """
    book = models.ForeignKey(
        Book,
        on_delete=models.CASCADE,
        verbose_name="å›¾ä¹¦",
        related_name="borrow_records"
    )
    borrower = models.ForeignKey(
        'system.Users',
        on_delete=models.CASCADE,
        verbose_name="å€Ÿé˜…äºº",
        related_name="borrow_records"
    )

    # å€Ÿé˜…ä¿¡æ¯
    borrow_date = models.DateField(auto_now_add=True, verbose_name="å€Ÿé˜…æ—¥æœŸ")
    due_date = models.DateField(verbose_name="åº”è¿˜æ—¥æœŸ")
    return_date = models.DateField(blank=True, null=True, verbose_name="å®é™…å½’è¿˜æ—¥æœŸ")

    # çŠ¶æ€
    status = models.CharField(
        max_length=20,
        choices=(
            ('borrowed', 'å€Ÿé˜…ä¸­'),
            ('returned', 'å·²å½’è¿˜'),
            ('overdue', 'å·²é€¾æœŸ'),
        ),
        default='borrowed',
        verbose_name="çŠ¶æ€"
    )

    # å¤‡æ³¨
    remarks = models.TextField(blank=True, null=True, verbose_name="å¤‡æ³¨")

    class Meta:
        db_table = 'dvadmin_borrow_record'
        verbose_name = 'å€Ÿé˜…è®°å½•'
        verbose_name_plural = verbose_name
        ordering = ['-borrow_date']

    def __str__(self):
        return f"{self.borrower.username} - {self.book.title}"
```

### 1.2 æ¨¡å‹è¯´æ˜

```python
# ç»§æ‰¿ CoreModel è‡ªåŠ¨è·å¾—ä»¥ä¸‹å­—æ®µï¼š
# - id: ä¸»é”®
# - create_time: åˆ›å»ºæ—¶é—´
# - update_time: æ›´æ–°æ—¶é—´
# - create_by: åˆ›å»ºäºº
# - update_by: æ›´æ–°äºº
# - dept: æ‰€å±éƒ¨é—¨ï¼ˆæ•°æ®æƒé™ç”¨ï¼‰

# å­—æ®µç±»å‹è¯´æ˜ï¼š
CharField(max_length=50)       # å­—ç¬¦ä¸²
TextField()                    # é•¿æ–‡æœ¬
IntegerField()                 # æ•´æ•°
DecimalField(10, 2)           # å°æ•°ï¼ˆæ€»é•¿åº¦10ï¼Œå°æ•°2ä½ï¼‰
DateField()                   # æ—¥æœŸ
BooleanField()                # å¸ƒå°”å€¼
ForeignKey()                  # å¤–é”®ï¼ˆå¤šå¯¹ä¸€ï¼‰
ImageField()                  # å›¾ç‰‡

# å…³ç³»è¯´æ˜ï¼š
Book.category  -> BookCategory  (å¤šå¯¹ä¸€)
Book.author    -> BookAuthor    (å¤šå¯¹ä¸€)
BorrowRecord.book -> Book        (å¤šå¯¹ä¸€)
BorrowRecord.borrower -> User    (å¤šå¯¹ä¸€)
```

### 1.3 æ•°æ®æ¨¡å‹å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BookCategory   â”‚
â”‚  (å›¾ä¹¦åˆ†ç±»)       â”‚
â”‚  - id           â”‚
â”‚  - name         â”‚
â”‚  - parent (è‡ªå…³è”)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 1
         â”‚
         â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Book        â”‚
â”‚   (å›¾ä¹¦)         â”‚
â”‚  - id           â”‚
â”‚  - title        â”‚
â”‚  - isbn         â”‚
â”‚  - price        â”‚
â”‚  - stock        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 1
         â”‚
         â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BorrowRecord   â”‚     â”‚  BookAuthor     â”‚
â”‚  (å€Ÿé˜…è®°å½•)       â”‚     â”‚  (ä½œè€…)           â”‚
â”‚  - book (FK)    â”‚â—„â”€â”€â”€â”€â”‚  - id           â”‚
â”‚  - borrower(FK) â”‚     â”‚  - name         â”‚
â”‚  - status       â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ N
         â”‚
         â”‚ 1
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Users       â”‚
â”‚   (ç³»ç»Ÿç”¨æˆ·)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¬¬äºŒæ­¥ï¼šåˆ›å»ºåºåˆ—åŒ–å™¨

### 2.1 åºåˆ—åŒ–å™¨ä»£ç 

**æ–‡ä»¶ä½ç½®:** `backend/dvadmin/system/serializers.py`

```python
from rest_framework import serializers
from dvadmin.utils.serializers import CustomModelSerializer
from dvadmin.system.models import Book, BookCategory, BookAuthor, BorrowRecord


class BookCategorySerializer(CustomModelSerializer):
    """
    å›¾ä¹¦åˆ†ç±»åºåˆ—åŒ–å™¨
    """
    parent_name = serializers.CharField(source='parent.name', read_only=True)
    book_count = serializers.SerializerMethodField()

    class Meta:
        model = BookCategory
        fields = '__all__'

    def get_book_count(self, obj):
        """è·å–è¯¥åˆ†ç±»ä¸‹çš„å›¾ä¹¦æ•°é‡"""
        return obj.books.count()


class BookAuthorSerializer(CustomModelSerializer):
    """
    å›¾ä¹¦ä½œè€…åºåˆ—åŒ–å™¨
    """
    book_count = serializers.SerializerMethodField()

    class Meta:
        model = BookAuthor
        fields = '__all__'

    def get_book_count(self, obj):
        """è·å–è¯¥ä½œè€…çš„å›¾ä¹¦æ•°é‡"""
        return obj.books.count()


class BookSerializer(CustomModelSerializer):
    """
    å›¾ä¹¦åºåˆ—åŒ–å™¨ï¼ˆè¯¦æƒ…ç”¨ï¼‰
    """
    category_name = serializers.CharField(source='category.name', read_only=True)
    author_name = serializers.CharField(source='author.name', read_only=True)
    author_gender = serializers.CharField(source='author.gender', read_only=True)

    is_overdue = serializers.SerializerMethodField()
    current_borrower = serializers.SerializerMethodField()

    class Meta:
        model = Book
        fields = '__all__'

    def get_is_overdue(self, obj):
        """æ£€æŸ¥æ˜¯å¦æœ‰é€¾æœŸæœªè¿˜"""
        from django.utils import timezone
        overdue_records = obj.borrow_records.filter(
            status='borrowed',
            due_date__lt=timezone.now().date()
        )
        return overdue_records.exists()

    def get_current_borrower(self, obj):
        """è·å–å½“å‰å€Ÿé˜…äºº"""
        current = obj.borrow_records.filter(status='borrowed').first()
        if current:
            return {
                'id': current.borrower.id,
                'username': current.borrower.username,
                'due_date': current.due_date
            }
        return None


class BookListSerializer(CustomModelSerializer):
    """
    å›¾ä¹¦åˆ—è¡¨åºåˆ—åŒ–å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
    """
    category_name = serializers.CharField(source='category.name', read_only=True)
    author_name = serializers.CharField(source='author.name', read_only=True)

    class Meta:
        model = Book
        fields = ['id', 'title', 'isbn', 'category_name', 'author_name',
                  'publisher', 'price', 'stock', 'is_available']


class BookCreateSerializer(CustomModelSerializer):
    """
    å›¾ä¹¦åˆ›å»ºåºåˆ—åŒ–å™¨
    """
    def validate_isbn(self, value):
        """éªŒè¯ ISBN æ ¼å¼"""
        if len(value) != 13:
            raise serializers.ValidationError("ISBN å¿…é¡»æ˜¯ 13 ä½")
        return value

    def validate_price(self, value):
        """éªŒè¯ä»·æ ¼"""
        if value <= 0:
            raise serializers.ValidationError("ä»·æ ¼å¿…é¡»å¤§äº 0")
        return value

    class Meta:
        model = Book
        fields = '__all__'


class BookUpdateSerializer(CustomModelSerializer):
    """
    å›¾ä¹¦æ›´æ–°åºåˆ—åŒ–å™¨
    """
    class Meta:
        model = Book
        fields = '__all__'


class BorrowRecordSerializer(CustomModelSerializer):
    """
    å€Ÿé˜…è®°å½•åºåˆ—åŒ–å™¨
    """
    book_title = serializers.CharField(source='book.title', read_only=True)
    book_isbn = serializers.CharField(source='book.isbn', read_only=True)
    borrower_name = serializers.CharField(source='borrower.username', read_only=True)
    borrower_dept = serializers.CharField(source='borrower.dept.name', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)

    class Meta:
        model = BorrowRecord
        fields = '__all__'


class BorrowCreateSerializer(CustomModelSerializer):
    """
    å€Ÿé˜…åˆ›å»ºåºåˆ—åŒ–å™¨
    """
    def validate(self, data):
        """éªŒè¯å€Ÿé˜…æ¡ä»¶"""
        book = data['book']

        if book.stock <= 0:
            raise serializers.ValidationError("è¯¥å›¾ä¹¦åº“å­˜ä¸è¶³")

        if not book.is_available:
            raise serializers.ValidationError("è¯¥å›¾ä¹¦æš‚æ—¶ä¸å¯å€Ÿ")

        borrower = self.context['request'].user
        existing = BorrowRecord.objects.filter(
            book=book,
            borrower=borrower,
            status='borrowed'
        )
        if existing.exists():
            raise serializers.ValidationError("æ‚¨å·²å€Ÿé˜…è¯¥ä¹¦ï¼Œè¯·å…ˆå½’è¿˜")

        return data

    def create(self, validated_data):
        """åˆ›å»ºå€Ÿé˜…è®°å½•ï¼ŒåŒæ—¶å‡å°‘åº“å­˜"""
        book = validated_data['book']
        book.stock -= 1
        book.save()
        return super().create(validated_data)

    class Meta:
        model = BorrowRecord
        fields = '__all__'
```

### 2.2 åºåˆ—åŒ–å™¨è¯´æ˜

```python
# åºåˆ—åŒ–å™¨çš„ä½œç”¨ï¼š
# 1. å°†æ¨¡å‹å¯¹è±¡è½¬æ¢ä¸º JSONï¼ˆåºåˆ—åŒ–ï¼‰
# 2. å°† JSON æ•°æ®è½¬æ¢ä¸ºæ¨¡å‹å¯¹è±¡ï¼ˆååºåˆ—åŒ–ï¼‰
# 3. æ•°æ®éªŒè¯

# CustomModelSerializer æä¾›çš„åŠŸèƒ½ï¼š
# - è‡ªåŠ¨å¤„ç† create_timeã€update_time ç­‰å­—æ®µ
# - è‡ªåŠ¨è®°å½• create_byã€update_byï¼ˆå½“å‰ç”¨æˆ·ï¼‰
# - æ”¯æŒå­—æ®µçº§æƒé™è¿‡æ»¤

# å­—æ®µç±»å‹è¯´æ˜ï¼š
ModelSerializer                     # ä½¿ç”¨æ¨¡å‹å®šä¹‰
SerializerMethodField()            # è‡ªå®šä¹‰æ–¹æ³•è·å–
source='category.name'             # ä»å…³è”å¯¹è±¡è·å–
read_only=True                     # åªè¯»ï¼ˆä¸æ¥æ”¶è¾“å…¥ï¼‰
```

### 2.3 åºåˆ—åŒ–å™¨å¯¹æ¯”

| åºåˆ—åŒ–å™¨ | ç”¨é€” | ç‰¹ç‚¹ |
|---------|------|------|
| `BookSerializer` | è¯¦æƒ…å±•ç¤º | åŒ…å«æ‰€æœ‰å­—æ®µå’Œå…³è”ä¿¡æ¯ |
| `BookListSerializer` | åˆ—è¡¨å±•ç¤º | ç²¾ç®€å­—æ®µï¼Œæé«˜æ€§èƒ½ |
| `BookCreateSerializer` | æ–°å¢å›¾ä¹¦ | åŒ…å«æ•°æ®éªŒè¯é€»è¾‘ |
| `BookUpdateSerializer` | æ›´æ–°å›¾ä¹¦ | å…è®¸ä¿®æ”¹æ‰€æœ‰å­—æ®µ |
| `BorrowCreateSerializer` | åˆ›å»ºå€Ÿé˜… | åŒ…å«ä¸šåŠ¡é€»è¾‘å’Œåº“å­˜æ‰£å‡ |

---

## ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºè§†å›¾é›†

### 3.1 è§†å›¾é›†ä»£ç 

**æ–‡ä»¶ä½ç½®:** `backend/dvadmin/system/views/book.py` (æ–°å»ºæ–‡ä»¶)

```python
from rest_framework.decorators import action
from rest_framework.permissions import IsAuthenticated
from django.db.models import Q, Count, F
from django.utils import timezone
from datetime import timedelta

from dvadmin.system.models import Book, BookCategory, BookAuthor, BorrowRecord
from dvadmin.system.serializers import (
    BookSerializer, BookListSerializer,
    BookCreateSerializer, BookUpdateSerializer,
    BookCategorySerializer, BookAuthorSerializer,
    BorrowRecordSerializer, BorrowCreateSerializer
)
from dvadmin.utils.viewset import CustomModelViewSet
from dvadmin.utils.json_response import DetailResponse, SuccessResponse, ErrorResponse


class BookCategoryViewSet(CustomModelViewSet):
    """
    å›¾ä¹¦åˆ†ç±»è§†å›¾é›†
    """
    queryset = BookCategory.objects.all()
    serializer_class = BookCategorySerializer
    filter_fields = ['name', 'code', 'parent']
    search_fields = ('name', 'description')


class BookAuthorViewSet(CustomModelViewSet):
    """
    å›¾ä¹¦ä½œè€…è§†å›¾é›†
    """
    queryset = BookAuthor.objects.all()
    serializer_class = BookAuthorSerializer
    filter_fields = ['name', 'gender', 'country']
    search_fields = ('name', 'biography')


class BookViewSet(CustomModelViewSet):
    """
    å›¾ä¹¦è§†å›¾é›†ï¼ˆæ ¸å¿ƒï¼‰

    åŠŸèƒ½ï¼š
    - list: è·å–å›¾ä¹¦åˆ—è¡¨
    - create: åˆ›å»ºå›¾ä¹¦
    - retrieve: è·å–å›¾ä¹¦è¯¦æƒ…
    - update: æ›´æ–°å›¾ä¹¦
    - destroy: åˆ é™¤å›¾ä¹¦
    - search: æœç´¢å›¾ä¹¦
    - statistics: ç»Ÿè®¡ä¿¡æ¯
    """

    queryset = Book.objects.select_related(
        'category', 'author'
    ).all()

    serializer_class = BookSerializer
    list_serializer_class = BookListSerializer
    create_serializer_class = BookCreateSerializer
    update_serializer_class = BookUpdateSerializer

    filter_fields = ['title', 'isbn', 'category', 'author', 'publisher', 'language']
    search_fields = ('title', 'subtitle', 'isbn', 'description')
    ordering_fields = '__all__'

    @action(methods=['get'], detail=False)
    def statistics(self, request):
        """
        è‡ªå®šä¹‰æ“ä½œï¼šç»Ÿè®¡ä¿¡æ¯
        è®¿é—®è·¯å¾„: GET /api/system/book/statistics/
        """
        total_books = Book.objects.count()
        total_categories = BookCategory.objects.count()
        total_authors = BookAuthor.objects.count()

        out_of_stock = Book.objects.filter(stock=0).count()
        low_stock = Book.objects.filter(stock__gt=0, stock__lte=5).count()

        category_stats = BookCategory.objects.annotate(
            book_count=Count('books')
        ).values('name', 'book_count')

        data = {
            'total_books': total_books,
            'total_categories': total_categories,
            'total_authors': total_authors,
            'out_of_stock': out_of_stock,
            'low_stock': low_stock,
            'category_stats': list(category_stats),
        }

        return DetailResponse(data=data, msg="è·å–ç»Ÿè®¡ä¿¡æ¯æˆåŠŸ")

    @action(methods=['get'], detail=True)
    def borrow_history(self, request, pk=None):
        """
        è‡ªå®šä¹‰æ“ä½œï¼šè·å–å€Ÿé˜…å†å²
        è®¿é—®è·¯å¾„: GET /api/system/book/{id}/borrow_history/
        """
        book = self.get_object()
        records = book.borrow_records.all()
        serializer = BorrowRecordSerializer(records, many=True)
        return DetailResponse(data=serializer.data, msg="è·å–å€Ÿé˜…å†å²æˆåŠŸ")

    @action(methods=['post'], detail=True)
    def mark_unavailable(self, request, pk=None):
        """
        è‡ªå®šä¹‰æ“ä½œï¼šæ ‡è®°ä¸ºä¸å¯å€Ÿé˜…
        è®¿é—®è·¯å¾„: POST /api/system/book/{id}/mark_unavailable/
        """
        book = self.get_object()
        book.is_available = False
        book.save()
        return DetailResponse(data={'id': book.id}, msg="æ ‡è®°æˆåŠŸ")


class BorrowRecordViewSet(CustomModelViewSet):
    """
    å€Ÿé˜…è®°å½•è§†å›¾é›†
    """
    queryset = BorrowRecord.objects.select_related(
        'book', 'borrower', 'book__category', 'book__author'
    ).all()

    serializer_class = BorrowRecordSerializer
    create_serializer_class = BorrowCreateSerializer

    filter_fields = ['book', 'borrower', 'status']
    search_fields = ('book__title', 'borrower__username')

    @action(methods=['post'], detail=True)
    def return_book(self, request, pk=None):
        """
        è‡ªå®šä¹‰æ“ä½œï¼šå½’è¿˜å›¾ä¹¦
        è®¿é—®è·¯å¾„: POST /api/system/borrow_record/{id}/return_book/
        """
        record = self.get_object()

        if record.status != 'borrowed':
            return ErrorResponse(msg="è¯¥è®°å½•ä¸æ˜¯å€Ÿé˜…ä¸­çŠ¶æ€")

        record.status = 'returned'
        record.return_date = timezone.now().date()
        record.save()

        book = record.book
        book.stock += 1
        book.save()

        return DetailResponse(data=record, msg="å½’è¿˜æˆåŠŸ")

    @action(methods=['get'], detail=False)
    def my_borrows(self, request):
        """
        è‡ªå®šä¹‰æ“ä½œï¼šæˆ‘çš„å€Ÿé˜…
        è®¿é—®è·¯å¾„: GET /api/system/borrow_record/my_borrows/
        """
        user = request.user
        records = self.queryset.filter(borrower=user)

        status_filter = request.query_params.get('status')
        if status_filter:
            records = records.filter(status=status_filter)

        page = self.paginate_queryset(records)
        if page is not None:
            serializer = self.get_serializer(page, many=True)
            return self.get_paginated_response(serializer.data)

        serializer = self.get_serializer(records, many=True)
        return DetailResponse(data=serializer.data, msg="è·å–æˆ‘çš„å€Ÿé˜…æˆåŠŸ")

    @action(methods=['get'], detail=False)
    def overdue_list(self, request):
        """
        è‡ªå®šä¹‰æ“ä½œï¼šé€¾æœŸåˆ—è¡¨
        è®¿é—®è·¯å¾„: GET /api/system/borrow_record/overdue_list/
        """
        today = timezone.now().date()
        overdue_records = self.queryset.filter(
            status='borrowed',
            due_date__lt=today
        )

        page = self.paginate_queryset(overdue_records)
        if page is not None:
            serializer = self.get_serializer(page, many=True)
            return self.get_paginated_response(serializer.data)

        serializer = self.get_serializer(overdue_records, many=True)
        return DetailResponse(data=serializer.data, msg="è·å–é€¾æœŸåˆ—è¡¨æˆåŠŸ")
```

### 3.2 è§†å›¾é›†è¯´æ˜

```python
# CustomModelViewSet è‡ªåŠ¨æä¾›çš„æ–¹æ³•ï¼š
# - list()      GET    /book/          åˆ—è¡¨
# - create()    POST   /book/          åˆ›å»º
# - retrieve()  GET    /book/{id}/     è¯¦æƒ…
# - update()    PUT    /book/{id}/     æ›´æ–°
# - destroy()   DELETE /book/{id}/     åˆ é™¤

# è‡ªå®šä¹‰æ“ä½œï¼ˆä½¿ç”¨ @action è£…é¥°å™¨ï¼‰ï¼š
# @action(methods=['get'], detail=False)
# def statistics(self, request):
#     # detail=False: /book/statistics/
#     # detail=True:  /book/{id}/statistics/

# è¿‡æ»¤å™¨ä½¿ç”¨ï¼š
# GET /api/system/book/?title=Python&category=1&search=Django
# è‡ªåŠ¨è¿‡æ»¤ï¼štitle=Python, category=1
# æ¨¡ç³Šæœç´¢ï¼šåŒ…å« Django çš„è®°å½•

# æ’åºï¼š
# GET /api/system/book/?ordering=-create_time
```

### 3.3 è§†å›¾é›†æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | HTTP | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| `list()` | GET | `/book/` | è·å–åˆ—è¡¨ |
| `create()` | POST | `/book/` | åˆ›å»ºè®°å½• |
| `retrieve()` | GET | `/book/{id}/` | è·å–è¯¦æƒ… |
| `update()` | PUT | `/book/{id}/` | æ›´æ–°è®°å½• |
| `destroy()` | DELETE | `/book/{id}/` | åˆ é™¤è®°å½• |
| `statistics()` | GET | `/book/statistics/` | è‡ªå®šä¹‰æ“ä½œ |
| `borrow_history()` | GET | `/book/{id}/borrow_history/` | è‡ªå®šä¹‰æ“ä½œ |

---

## ç¬¬å››æ­¥ï¼šé…ç½®è·¯ç”±

### 4.1 è·¯ç”±ä»£ç 

**æ–‡ä»¶ä½ç½®:** `backend/dvadmin/system/urls.py`

```python
from django.urls import path, include
from rest_framework.routers import SimpleRouter
from dvadmin.system.views.book import (
    BookViewSet,
    BookCategoryViewSet,
    BookAuthorViewSet,
    BorrowRecordViewSet
)

# åˆ›å»ºè·¯ç”±å™¨
router = SimpleRouter()

# æ³¨å†Œè§†å›¾é›†
router.register(r'book_category', BookCategoryViewSet)
router.register(r'book_author', BookAuthorViewSet)
router.register(r'book', BookViewSet)
router.register(r'borrow_record', BorrowRecordViewSet)

# æ·»åŠ åˆ° urlpatterns
urlpatterns += [
    path('api/system/book/', include(router.urls)),
]
```

### 4.2 ç”Ÿæˆçš„è·¯ç”±åˆ—è¡¨

```
# å›¾ä¹¦ç›¸å…³
GET    /api/system/book/                    å›¾ä¹¦åˆ—è¡¨
POST   /api/system/book/                    åˆ›å»ºå›¾ä¹¦
GET    /api/system/book/{id}/               å›¾ä¹¦è¯¦æƒ…
PUT    /api/system/book/{id}/               æ›´æ–°å›¾ä¹¦
DELETE /api/system/book/{id}/               åˆ é™¤å›¾ä¹¦
GET    /api/system/book/statistics/         ç»Ÿè®¡ä¿¡æ¯
GET    /api/system/book/{id}/borrow_history/ å€Ÿé˜…å†å²
POST   /api/system/book/{id}/mark_unavailable/ æ ‡è®°ä¸å¯å€Ÿ

# åˆ†ç±»ç›¸å…³
GET    /api/system/book_category/           åˆ†ç±»åˆ—è¡¨
POST   /api/system/book_category/           åˆ›å»ºåˆ†ç±»
GET    /api/system/book_category/{id}/      åˆ†ç±»è¯¦æƒ…
PUT    /api/system/book_category/{id}/      æ›´æ–°åˆ†ç±»
DELETE /api/system/book_category/{id}/      åˆ é™¤åˆ†ç±»

# ä½œè€…ç›¸å…³
GET    /api/system/book_author/             ä½œè€…åˆ—è¡¨
POST   /api/system/book_author/             åˆ›å»ºä½œè€…

# å€Ÿé˜…ç›¸å…³
GET    /api/system/borrow_record/           å€Ÿé˜…è®°å½•
POST   /api/system/borrow_record/           åˆ›å»ºå€Ÿé˜…
GET    /api/system/borrow_record/my_borrows/ æˆ‘çš„å€Ÿé˜…
POST   /api/system/borrow_record/{id}/return_book/ å½’è¿˜å›¾ä¹¦
GET    /api/system/borrow_record/overdue_list/ é€¾æœŸåˆ—è¡¨
```

### 4.3 è·¯ç”±è¯´æ˜

```python
# è·¯ç”±å™¨ç±»å‹ï¼š
# SimpleRouter:    åŸºç¡€è·¯ç”±ï¼Œç”Ÿæˆæ ‡å‡† RESTful è·¯ç”±
# DefaultRouter:   é»˜è®¤è·¯ç”±ï¼Œé¢å¤–ç”Ÿæˆæ ¹ API é¡µé¢

# æ³¨å†Œè·¯ç”±ï¼š
router.register(prefix, viewset, basename)
# prefix:    è·¯ç”±å‰ç¼€ï¼Œå¦‚ 'book'
# viewset:   è§†å›¾é›†ç±»
# basename:  åŸºç¡€åç§°ï¼ˆç”¨äºç”Ÿæˆ URL åç§°ï¼‰

# è·¯ç”±è‡ªåŠ¨ç”Ÿæˆè§„åˆ™ï¼š
# {prefix}/                    -> list, create
# {prefix}/{id}/               -> retrieve, update, destroy
# {prefix}/{id}/{action}/      -> custom action (detail=True)
# {prefix}/{action}/           -> custom action (detail=False)
```

---

## ç¬¬äº”æ­¥ï¼šæ•°æ®åº“è¿ç§»

### 5.1 ç”Ÿæˆè¿ç§»æ–‡ä»¶

```bash
# è¿›å…¥åç«¯ç›®å½•
cd django-vue3-admin-master/backend

# ç”Ÿæˆè¿ç§»æ–‡ä»¶ï¼ˆæ£€æµ‹æ¨¡å‹å˜åŒ–ï¼‰
python manage.py makemigrations system

# è¾“å‡ºç¤ºä¾‹ï¼š
# Migrations for 'system':
#   backend/dvadmin/system/migrations/0002_book_category_book_author_book_borrow_record.py
#     - Create model BookCategory
#     - Create model BookAuthor
#     - Create model Book
#     - Create model BorrowRecord
```

### 5.2 æ‰§è¡Œè¿ç§»

```bash
# æ‰§è¡Œè¿ç§»ï¼ˆåº”ç”¨åˆ°æ•°æ®åº“ï¼‰
python manage.py migrate system

# è¾“å‡ºç¤ºä¾‹ï¼š
# Running migrations:
#   Applying system.0002_book_category_book_author_book_borrow_record... OK
```

### 5.3 æŸ¥çœ‹ç”Ÿæˆçš„è¡¨

```sql
-- åœ¨æ•°æ®åº“ä¸­å¯ä»¥çœ‹åˆ°ä»¥ä¸‹è¡¨ï¼š
dvadmin_book_category          -- å›¾ä¹¦åˆ†ç±»è¡¨
dvadmin_book_author            -- ä½œè€…è¡¨
dvadmin_book                   -- å›¾ä¹¦è¡¨
dvadmin_borrow_record          -- å€Ÿé˜…è®°å½•è¡¨

-- æ¯ä¸ªè¡¨è‡ªåŠ¨åŒ…å«çš„å­—æ®µï¼š
-- id: ä¸»é”®
-- create_time: åˆ›å»ºæ—¶é—´
-- update_time: æ›´æ–°æ—¶é—´
-- create_by_id: åˆ›å»ºäººIDï¼ˆå¤–é”®ï¼‰
-- update_by_id: æ›´æ–°äººIDï¼ˆå¤–é”®ï¼‰
-- dept_id: éƒ¨é—¨IDï¼ˆå¤–é”®ï¼Œæ•°æ®æƒé™ç”¨ï¼‰
```

### 5.4 è¿ç§»æ–‡ä»¶ç¤ºä¾‹

```python
# backend/dvadmin/system/migrations/0002_book_xxx.py

from django.db import migrations, models
import django.db.models.deletion

class Migration(migrations.Migration):
    dependencies = [
        ('system', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='BookCategory',
            fields=[
                ('id', models.BigAutoField(primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=50, verbose_name='åˆ†ç±»åç§°')),
                ('code', models.CharField(max_length=20, unique=True, verbose_name='åˆ†ç±»ç¼–ç ')),
                # ... å…¶ä»–å­—æ®µ
            ],
            options={
                'db_table': 'dvadmin_book_category',
                'verbose_name': 'å›¾ä¹¦åˆ†ç±»',
            },
        ),
        # ... å…¶ä»–æ¨¡å‹
    ]
```

### 5.5 è¿ç§»å‘½ä»¤è¯´æ˜

```bash
# å¸¸ç”¨è¿ç§»å‘½ä»¤ï¼š
python manage.py makemigrations          # æ£€æµ‹å˜åŒ–ï¼Œç”Ÿæˆè¿ç§»æ–‡ä»¶
python manage.py makemigrations system   # åªæ£€æµ‹ system åº”ç”¨
python manage.py migrate                 # æ‰§è¡Œæ‰€æœ‰æœªæ‰§è¡Œçš„è¿ç§»
python manage.py migrate system          # åªæ‰§è¡Œ system åº”ç”¨çš„è¿ç§»
python manage.py showmigrations          # æŸ¥çœ‹è¿ç§»çŠ¶æ€
python manage.py showmigrations system   # æŸ¥çœ‹ system åº”ç”¨çš„è¿ç§»çŠ¶æ€
python manage.py migrate system zero     # å›æ»š system åº”ç”¨çš„æ‰€æœ‰è¿ç§»
python manage.py makemigrations --empty system  # åˆ›å»ºç©ºè¿ç§»æ–‡ä»¶
```

---

## ç¬¬å…­æ­¥ï¼šæƒé™å’Œèœå•é…ç½®

### 6.1 é…ç½®èœå•ï¼ˆåœ¨åå°ï¼‰

**ç™»å½•åå°:**
```
URL: http://localhost:8080/
ç”¨æˆ·å: superadmin
å¯†ç : admin123456
```

**æ­¥éª¤ï¼š**

1. **åˆ›å»ºçˆ¶èœå•ï¼ˆå›¾ä¹¦ç®¡ç†ï¼‰**
   ```
   ç³»ç»Ÿç®¡ç† -> èœå•ç®¡ç† -> æ–°å¢

   èœå•åç§°: å›¾ä¹¦ç®¡ç†
   èœå•ç±»å‹: ç›®å½•(M)
   è·¯ç”±åœ°å€: /book
   ç»„ä»¶è·¯å¾„: Layout
   å›¾æ ‡: book
   æ’åº: 10
   çŠ¶æ€: å¼€å¯
   ```

2. **åˆ›å»ºå­èœå•ï¼ˆå›¾ä¹¦åˆ—è¡¨ï¼‰**
   ```
   ç³»ç»Ÿç®¡ç† -> èœå•ç®¡ç† -> æ–°å¢

   èœå•åç§°: å›¾ä¹¦åˆ—è¡¨
   çˆ¶çº§èœå•: å›¾ä¹¦ç®¡ç†
   èœå•ç±»å‹: èœå•(C)
   è·¯ç”±åœ°å€: list
   ç»„ä»¶è·¯å¾„: views/book/book-list
   æƒé™æ ‡è¯†: system:book:list
   çŠ¶æ€: å¼€å¯
   ```

3. **åˆ›å»ºæŒ‰é’®æƒé™**
   ```
   ç³»ç»Ÿç®¡ç† -> èœå•ç®¡ç† -> æ–°å¢

   èœå•åç§°: æ–°å¢å›¾ä¹¦
   çˆ¶çº§èœå•: å›¾ä¹¦åˆ—è¡¨
   èœå•ç±»å‹: æŒ‰é’®(F)
   æƒé™æ ‡è¯†: system:book:create
   çŠ¶æ€: å¼€å¯

   # é‡å¤åˆ›å»ºå…¶ä»–æŒ‰é’®ï¼š
   - ç¼–è¾‘å›¾ä¹¦: system:book:update
   - åˆ é™¤å›¾ä¹¦: system:book:destroy
   - æŸ¥è¯¢å›¾ä¹¦: system:book:retrieve
   ```

### 6.2 é…ç½®å­—æ®µæƒé™

```
ç³»ç»Ÿç®¡ç† -> å­—æ®µæƒé™ç®¡ç† -> æ–°å¢

è§’è‰²: æ™®é€šç”¨æˆ·
æ¨¡å‹: Book

é…ç½®å­—æ®µï¼š
âœ“ titleï¼ˆå¯æŸ¥è¯¢ï¼‰
âœ“ authorï¼ˆå¯æŸ¥è¯¢ï¼‰
âœ— priceï¼ˆä¸å¯æŸ¥è¯¢ - æ•æ„Ÿä¿¡æ¯ï¼‰
âœ— stockï¼ˆä¸å¯æŸ¥è¯¢ - å†…éƒ¨ä¿¡æ¯ï¼‰

æ•ˆæœï¼š
æ™®é€šç”¨æˆ·è®¿é—®å›¾ä¹¦åˆ—è¡¨æ—¶ï¼Œè‡ªåŠ¨è¿‡æ»¤æ‰ price å’Œ stock å­—æ®µ
```

### 6.3 é…ç½®æ•°æ®æƒé™

```
ç³»ç»Ÿç®¡ç† -> è§’è‰²ç®¡ç† -> æ–°å¢

è§’è‰²åç§°: å›¾ä¹¦ç®¡ç†å‘˜
æƒé™æ ‡è¯†: book_admin
æ•°æ®æƒé™èŒƒå›´: æœ¬éƒ¨é—¨æ•°æ®
åˆ†é…èœå•: å‹¾é€‰å›¾ä¹¦ç®¡ç†ç›¸å…³èœå•
åˆ†é…æŒ‰é’®æƒé™: å‹¾é€‰å¢åˆ æ”¹æŸ¥æŒ‰é’®

æ•°æ®æƒé™è¯´æ˜ï¼š
1 = å…¨éƒ¨æ•°æ®æƒé™       # èƒ½çœ‹åˆ°æ‰€æœ‰å›¾ä¹¦
2 = è‡ªå®šä¹‰æ•°æ®æƒé™      # æŒ‡å®šéƒ¨é—¨çš„å›¾ä¹¦
3 = æœ¬éƒ¨é—¨æ•°æ®æƒé™      # åªèƒ½çœ‹åˆ°æœ¬éƒ¨é—¨çš„å›¾ä¹¦
4 = æœ¬éƒ¨é—¨åŠä»¥ä¸‹æ•°æ®æƒé™ # æœ¬éƒ¨é—¨ + å­éƒ¨é—¨
5 = ä»…æœ¬äººæ•°æ®æƒé™      # åªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„å›¾ä¹¦
```

### 6.4 ä¸‰çº§æƒé™ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           èœå•æƒé™                        â”‚
â”‚  æ§åˆ¶ç”¨æˆ·èƒ½è®¿é—®å“ªäº›é¡µé¢                    â”‚
â”‚  é…ç½®ä½ç½®: èœå•ç®¡ç†                        â”‚
â”‚  ç¤ºä¾‹: ç”¨æˆ·åªèƒ½çœ‹åˆ°"å›¾ä¹¦ç®¡ç†"èœå•            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æŒ‰é’®æƒé™                        â”‚
â”‚  æ§åˆ¶ç”¨æˆ·èƒ½æ‰§è¡Œå“ªäº›æ“ä½œ                    â”‚
â”‚  é…ç½®ä½ç½®: èœå•ç®¡ç†ï¼ˆæŒ‰é’®ç±»å‹ï¼‰             â”‚
â”‚  ç¤ºä¾‹: ç”¨æˆ·åªèƒ½"æŸ¥çœ‹"ï¼Œä¸èƒ½"åˆ é™¤"           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å­—æ®µæƒé™                        â”‚
â”‚  æ§åˆ¶ç”¨æˆ·èƒ½çœ‹åˆ°å“ªäº›æ•°æ®åˆ—                  â”‚
â”‚  é…ç½®ä½ç½®: å­—æ®µæƒé™ç®¡ç†                    â”‚
â”‚  ç¤ºä¾‹: ç”¨æˆ·çœ‹ä¸åˆ°"ä»·æ ¼"å’Œ"åº“å­˜"å­—æ®µ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ•°æ®æƒé™                        â”‚
â”‚  æ§åˆ¶ç”¨æˆ·èƒ½çœ‹åˆ°å“ªäº›æ•°æ®è¡Œ                  â”‚
â”‚  é…ç½®ä½ç½®: è§’è‰²ç®¡ç†ï¼ˆæ•°æ®èŒƒå›´ï¼‰             â”‚
â”‚  ç¤ºä¾‹: ç”¨æˆ·åªèƒ½çœ‹åˆ°æœ¬éƒ¨é—¨çš„æ•°æ®             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¬¬ä¸ƒæ­¥ï¼šæµ‹è¯• API æ¥å£

### 7.1 å¯åŠ¨åç«¯æœåŠ¡

```bash
# æ–¹å¼ 1: ä½¿ç”¨ uvicornï¼ˆæ¨èï¼Œæ”¯æŒ WebSocketï¼‰
uvicorn application.asgi:application --host 0.0.0.0 --port 9000 --reload

# æ–¹å¼ 2: ä½¿ç”¨ Django å¼€å‘æœåŠ¡å™¨ï¼ˆä¸æ”¯æŒ WebSocketï¼‰
python manage.py runserver 9000

# å¯åŠ¨æˆåŠŸåï¼š
# Uvicorn running on http://0.0.0.0:9000
```

### 7.2 è®¿é—® Swagger æ–‡æ¡£

```
æµè§ˆå™¨è®¿é—®: http://localhost:9000/

å¯ä»¥çœ‹åˆ°ï¼š
- æ‰€æœ‰ API æ¥å£åˆ—è¡¨
- è¯·æ±‚å‚æ•°è¯´æ˜
- åœ¨çº¿æµ‹è¯•åŠŸèƒ½
```

### 7.3 æ¥å£æµ‹è¯•ç¤ºä¾‹

#### 1ï¸âƒ£ ç™»å½•è·å– Token

```bash
# è¯·æ±‚
curl -X POST http://localhost:9000/api/login/ \
  -H "Content-Type: application/json" \
  -d '{
    "username": "superadmin",
    "password": "admin123456"
  }'

# å“åº”
{
  "code": 2000,
  "msg": "æˆåŠŸ",
  "data": {
    "token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "name": "è¶…çº§ç®¡ç†å‘˜",
    "avatar": "..."
  }
}

# ä¿å­˜ tokenï¼Œåç»­è¯·æ±‚ä½¿ç”¨
export TOKEN="eyJ0eXAiOiJKV1QiLCJhbGc..."
```

#### 2ï¸âƒ£ åˆ›å»ºå›¾ä¹¦åˆ†ç±»

```bash
curl -X POST http://localhost:9000/api/system/book_category/ \
  -H "Authorization: JWT $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "è®¡ç®—æœºæŠ€æœ¯",
    "code": "CS",
    "description": "è®¡ç®—æœºç›¸å…³å›¾ä¹¦"
  }'

# å“åº”
{
  "code": 2000,
  "msg": "æ–°å¢æˆåŠŸ",
  "data": {
    "id": 1,
    "name": "è®¡ç®—æœºæŠ€æœ¯",
    "code": "CS",
    "description": "è®¡ç®—æœºç›¸å…³å›¾ä¹¦",
    "create_time": "2024-01-24 10:00:00"
  }
}
```

#### 3ï¸âƒ£ åˆ›å»ºå›¾ä¹¦

```bash
curl -X POST http://localhost:9000/api/system/book/ \
  -H "Authorization: JWT $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Pythonç¼–ç¨‹ä»å…¥é—¨åˆ°ç²¾é€š",
    "isbn": "9787111111111",
    "category": 1,
    "author": 1,
    "publisher": "æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾",
    "publish_date": "2024-01-01",
    "price": 89.00,
    "stock": 10,
    "location": "A-01-01"
  }'

# å“åº”
{
  "code": 2000,
  "msg": "æ–°å¢æˆåŠŸ",
  "data": {
    "id": 1,
    "title": "Pythonç¼–ç¨‹ä»å…¥é—¨åˆ°ç²¾é€š",
    "isbn": "9787111111111",
    "category_name": "è®¡ç®—æœºæŠ€æœ¯",
    "author_name": "Pythonå¤§ç¥",
    "price": 89.00,
    "stock": 10
  }
}
```

#### 4ï¸âƒ£ è·å–å›¾ä¹¦åˆ—è¡¨ï¼ˆå¸¦è¿‡æ»¤ï¼‰

```bash
curl -X GET "http://localhost:9000/api/system/book/?search=Python&category=1&ordering=-price" \
  -H "Authorization: JWT $TOKEN"

# å“åº”
{
  "code": 2000,
  "msg": "è·å–æˆåŠŸ",
  "data": [...],
  "total": 1,
  "page": 1,
  "limit": 10
}
```

#### 5ï¸âƒ£ è·å–ç»Ÿè®¡ä¿¡æ¯

```bash
curl -X GET http://localhost:9000/api/system/book/statistics/ \
  -H "Authorization: JWT $TOKEN"

# å“åº”
{
  "code": 2000,
  "msg": "è·å–ç»Ÿè®¡ä¿¡æ¯æˆåŠŸ",
  "data": {
    "total_books": 100,
    "total_categories": 5,
    "total_authors": 50,
    "out_of_stock": 3,
    "low_stock": 10,
    "category_stats": [...]
  }
}
```

#### 6ï¸âƒ£ åˆ›å»ºå€Ÿé˜…è®°å½•

```bash
curl -X POST http://localhost:9000/api/system/borrow_record/ \
  -H "Authorization: JWT $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "book": 1,
    "due_date": "2024-02-24"
  }'

# å“åº”
{
  "code": 2000,
  "msg": "æ–°å¢æˆåŠŸ",
  "data": {
    "id": 1,
    "book": 1,
    "borrow_date": "2024-01-24",
    "due_date": "2024-02-24",
    "status": "borrowed"
  }
}
```

#### 7ï¸âƒ£ å½’è¿˜å›¾ä¹¦

```bash
curl -X POST http://localhost:9000/api/system/borrow_record/1/return_book/ \
  -H "Authorization: JWT $TOKEN"

# å“åº”
{
  "code": 2000,
  "msg": "å½’è¿˜æˆåŠŸ",
  "data": {
    "id": 1,
    "status": "returned",
    "return_date": "2024-01-24"
  }
}
```

---

## å®Œæ•´å¼€å‘æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DVAdmin å¼€å‘æµç¨‹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬1æ­¥ï¼šåˆ›å»ºæ•°æ®æ¨¡å‹
â”‚
â”œâ”€ å®šä¹‰æ¨¡å‹ç±» â†’ dvadmin/system/models.py
â”‚  â”œâ”€ ç»§æ‰¿ CoreModelï¼ˆè‡ªåŠ¨å­—æ®µï¼‰
â”‚  â”œâ”€ å®šä¹‰ä¸šåŠ¡å­—æ®µ
â”‚  â””â”€ é…ç½® Meta é€‰é¡¹
â”‚
â”œâ”€ ç”Ÿæˆè¿ç§»æ–‡ä»¶
â”‚  â””â”€ python manage.py makemigrations system
â”‚
â””â”€ æ‰§è¡Œè¿ç§»
   â””â”€ python manage.py migrate system


ç¬¬2æ­¥ï¼šåˆ›å»ºåºåˆ—åŒ–å™¨
â”‚
â””â”€ å®šä¹‰åºåˆ—åŒ–å™¨ç±» â†’ dvadmin/system/serializers.py
   â”œâ”€ ç»§æ‰¿ CustomModelSerializer
   â”œâ”€ é…ç½® Metaï¼ˆmodel, fieldsï¼‰
   â”œâ”€ æ·»åŠ åªè¯»å­—æ®µ
   â”œâ”€ è‡ªå®šä¹‰æ–¹æ³•å­—æ®µ
   â””â”€ æ·»åŠ éªŒè¯é€»è¾‘


ç¬¬3æ­¥ï¼šåˆ›å»ºè§†å›¾é›†
â”‚
â””â”€ å®šä¹‰è§†å›¾é›†ç±» â†’ dvadmin/system/views/book.py
   â”œâ”€ ç»§æ‰¿ CustomModelViewSet
   â”œâ”€ é…ç½® queryset
   â”œâ”€ é…ç½® serializer_class
   â”œâ”€ é…ç½®ä¸åŒæ“ä½œçš„åºåˆ—åŒ–å™¨
   â”œâ”€ é…ç½®è¿‡æ»¤å’Œæœç´¢
   â””â”€ æ·»åŠ è‡ªå®šä¹‰æ“ä½œï¼ˆ@actionï¼‰


ç¬¬4æ­¥ï¼šé…ç½®è·¯ç”±
â”‚
â””â”€ æ³¨å†Œè·¯ç”± â†’ dvadmin/system/urls.py
   â”œâ”€ åˆ›å»ºè·¯ç”±å™¨ï¼ˆSimpleRouterï¼‰
   â”œâ”€ æ³¨å†Œè§†å›¾é›†ï¼ˆrouter.registerï¼‰
   â””â”€ åŒ…å«è·¯ç”±ï¼ˆincludeï¼‰


ç¬¬5æ­¥ï¼šé…ç½®æƒé™
â”‚
â”œâ”€ èœå•æƒé™
â”‚  â””â”€ åå° â†’ èœå•ç®¡ç† â†’ é…ç½®èœå•å’ŒæŒ‰é’®
â”‚
â”œâ”€ å­—æ®µæƒé™
â”‚  â””â”€ åå° â†’ å­—æ®µæƒé™ç®¡ç† â†’ é…ç½®å¯è®¿é—®å­—æ®µ
â”‚
â””â”€ æ•°æ®æƒé™
   â””â”€ åå° â†’ è§’è‰²ç®¡ç† â†’ é…ç½®æ•°æ®èŒƒå›´


ç¬¬6æ­¥ï¼šæµ‹è¯•
â”‚
â”œâ”€ å¯åŠ¨æœåŠ¡
â”‚  â””â”€ uvicorn application.asgi:application --port 9000
â”‚
â”œâ”€ è®¿é—®æ–‡æ¡£
â”‚  â””â”€ http://localhost:9000/
â”‚
â””â”€ æµ‹è¯•æ¥å£
   â”œâ”€ ç™»å½•è·å– Token
   â”œâ”€ CRUD æ“ä½œ
   â”œâ”€ è¿‡æ»¤æœç´¢
   â”œâ”€ è‡ªå®šä¹‰æ“ä½œ
   â””â”€ æƒé™éªŒè¯
```

---

## å…³é”®é…ç½®è¯´æ˜

### 1. settings.py é…ç½®

```python
# ç¡®ä¿åº”ç”¨å·²æ³¨å†Œ
INSTALLED_APPS = [
    # ...
    "dvadmin.system",  # ç³»ç»Ÿæ¨¡å—ï¼ˆåŒ…å«æˆ‘ä»¬çš„æ¨¡å‹ï¼‰
]

# æƒé™é…ç½®
COLUMN_EXCLUDE_APPS = ['channels', 'captcha']
# æ’é™¤çš„åº”ç”¨ä¸å‚ä¸å­—æ®µæƒé™æ§åˆ¶

# REST Framework é…ç½®
REST_FRAMEWORK = {
    'DEFAULT_FILTER_BACKENDS': (
        "dvadmin.utils.filters.CustomDjangoFilterBackend",
        "rest_framework.filters.SearchFilter",
        "rest_framework.filters.OrderingFilter",
    ),
    'DEFAULT_PAGINATION_CLASS': "dvadmin.utils.pagination.CustomPagination",
    'DEFAULT_AUTHENTICATION_CLASSES': (
        "rest_framework_simplejwt.authentication.JWTAuthentication",
    ),
    'DEFAULT_PERMISSION_CLASSES': [
        "rest_framework.permissions.IsAuthenticated",
    ],
    'EXCEPTION_HANDLER': "dvadmin.utils.exception.CustomExceptionHandler",
}
```

### 2. è¿‡æ»¤å™¨ä½¿ç”¨

```python
# åœ¨è§†å›¾é›†ä¸­é…ç½®
class BookViewSet(CustomModelViewSet):
    filter_fields = ['title', 'category', 'author']
    search_fields = ('title', 'description')
    ordering_fields = '__all__'

# å‰ç«¯è¯·æ±‚ç¤ºä¾‹
GET /api/system/book/?title=Python              # ç²¾ç¡®è¿‡æ»¤
GET /api/system/book/?category=1                # å¤–é”®è¿‡æ»¤
GET /api/system/book/?search=Django             # æ¨¡ç³Šæœç´¢
GET /api/system/book/?ordering=-price           # æ’åº
GET /api/system/book/?title=Py&category=1       # ç»„åˆè¿‡æ»¤
```

### 3. åˆ†é¡µé…ç½®

```python
# é»˜è®¤åˆ†é¡µ
{
    "code": 2000,
    "data": [...],
    "total": 100,        # æ€»è®°å½•æ•°
    "page": 1,           # å½“å‰é¡µ
    "limit": 10          # æ¯é¡µæ•°é‡
}

# å‰ç«¯æ§åˆ¶
GET /api/system/book/?page=2&limit=20
```

### 4. å¼‚å¸¸å¤„ç†

```python
# ç»Ÿä¸€å“åº”æ ¼å¼
# æˆåŠŸ
{
    "code": 2000,
    "msg": "æ“ä½œæˆåŠŸ",
    "data": {...}
}

# å¤±è´¥
{
    "code": 2001,
    "msg": "é”™è¯¯ä¿¡æ¯",
    "data": null
}

# è‡ªå®šä¹‰å¼‚å¸¸
from dvadmin.utils.json_response import ErrorResponse

if book.stock <= 0:
    return ErrorResponse(msg="åº“å­˜ä¸è¶³")
```

---

## æ–‡ä»¶æ¸…å•

```
backend/
â”œâ”€â”€ dvadmin/
â”‚   â”œâ”€â”€ system/
â”‚   â”‚   â”œâ”€â”€ models.py                 # âœï¸ æ·»åŠ ï¼šBook, BookCategory, BookAuthor, BorrowRecord
â”‚   â”‚   â”œâ”€â”€ serializers.py            # âœï¸ æ·»åŠ ï¼šæ‰€æœ‰åºåˆ—åŒ–å™¨
â”‚   â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â”‚   â””â”€â”€ book.py               # âœï¸ æ–°å»ºï¼šæ‰€æœ‰è§†å›¾é›†
â”‚   â”‚   â””â”€â”€ urls.py                   # âœï¸ ä¿®æ”¹ï¼šæ³¨å†Œè·¯ç”±
â”‚   â””â”€â”€ migrations/
â”‚       â””â”€â”€ system/
â”‚           â””â”€â”€ 0002_book_xxx.py      # ğŸ”„ è‡ªåŠ¨ç”Ÿæˆï¼šè¿ç§»æ–‡ä»¶
```

---

## æ€»ç»“

é€šè¿‡æœ¬æ•™ç¨‹ï¼Œä½ å·²ç»äº†è§£äº†ï¼š

âœ… **æ¨¡å‹å®šä¹‰** â†’ æ•°æ®åº“è¡¨ç»“æ„
âœ… **åºåˆ—åŒ–å™¨** â†’ æ•°æ®éªŒè¯å’Œè½¬æ¢
âœ… **è§†å›¾é›†** â†’ ä¸šåŠ¡é€»è¾‘å¤„ç†
âœ… **è·¯ç”±é…ç½®** â†’ URL æ˜ å°„
âœ… **æƒé™æ§åˆ¶** â†’ ä¸‰çº§æƒé™ç³»ç»Ÿ
âœ… **API æµ‹è¯•** â†’ æ¥å£è°ƒç”¨

è¿™å°±æ˜¯ DVAdmin çš„å®Œæ•´å¼€å‘é“¾è·¯ï¼æŒæ¡äº†è¿™äº›ï¼Œä½ å°±å¯ä»¥å¼€å‘ä»»ä½•ä¸šåŠ¡æ¨¡å—äº†ã€‚

---

## é™„å½•

### A. å¸¸è§é—®é¢˜

**Q1: è¿ç§»æ–‡ä»¶å†²çªæ€ä¹ˆåŠï¼Ÿ**
```bash
# åˆ é™¤è¿ç§»æ–‡ä»¶ï¼ˆä¿ç•™ __init__.pyï¼‰
# é‡æ–°ç”Ÿæˆ
python manage.py makemigrations system --empty
```

**Q2: å¦‚ä½•è°ƒè¯•åºåˆ—åŒ–å™¨ï¼Ÿ**
```python
def validate(self, data):
    print(f"æ¥æ”¶åˆ°çš„æ•°æ®: {data}")
    # ... éªŒè¯é€»è¾‘
    return data
```

**Q3: å¦‚ä½•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼Ÿ**
```python
# ä½¿ç”¨ select_related å‡å°‘æŸ¥è¯¢æ¬¡æ•°
queryset = Book.objects.select_related('category', 'author').all()

# ä½¿ç”¨ prefetch_related å¤„ç†å¤šå¯¹å¤š
queryset = Book.objects.prefetch_related('tags').all()

# åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
queryset = Book.objects.values('id', 'title', 'price')
```

### B. å‚è€ƒèµ„æº

- [Django å®˜æ–¹æ–‡æ¡£](https://docs.djangoproject.com/zh-hans/)
- [DRF å®˜æ–¹æ–‡æ¡£](https://www.django-rest-framework.org/)
- [DVAdmin å®˜æ–¹æ–‡æ¡£](https://django-vue-admin.com)
- [DVAdmin æºç ](https://gitee.com/huge-dream/django-vue3-admin)

---

**æ–‡æ¡£ç‰ˆæœ¬:** v1.0.0
**æœ€åæ›´æ–°:** 2024-01-25
**ç»´æŠ¤è€…:** Claude AI

å¦‚æœ‰ç–‘é—®ï¼Œè¯·æŸ¥é˜…å®˜æ–¹æ–‡æ¡£æˆ–åŠ å…¥ç¤¾åŒºè®¨è®ºã€‚
