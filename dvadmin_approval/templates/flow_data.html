<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no,viewport-fit=cover" />
    <title>待处理</title>
      <script src="//cdn.kungfumars.com/kfm-code-qr-jump/vue.global.prod.js"></script>
      <script src="//cdn.kungfumars.com/kfm-code-qr-jump/axios-1.3.6.min.js"></script>
      <script src="/static/js/xe-utils.js"></script>
      <script  src="/static/js/vant4.min.js"></script>
    <link rel="stylesheet" href="/static/css/vant4.css">
      <link rel="stylesheet" href="/static/css/public.css">
    <style>
       .form-list{
           height: 82vh;overflow-y: scroll;
        }
    </style>
</head>
<body>
  <div id="app">
        <div v-if="is_authentication">
            <div>
                <van-tabs v-model:active="tabIndex" sticky @click-tab="clickTab">
                  <van-tab v-for="(item,index) in tabGrid" :title="item.name">
                  </van-tab>
                </van-tabs>
                <div>
                    <van-search v-model="search" placeholder="请输入搜索关键词" clearable  show-action  @search="onSearch">
                         <template #action>
                            <div @click="onSearch">搜索</div>
                          </template>
                    </van-search>
                    <van-action-sheet v-model:show="filterShow" title="标题">
                      <div class="content">内容</div>
                    </van-action-sheet>
                </div>
            </div>
            <div id="scroll"  class="form-list">
                <van-list ref="listRef"
                        :offset="50"
                  v-model:loading="loading"
                  :finished="finished"
                  finished-text="没有更多了"
                  @load="getPageList"
                >
                    <van-cell-group inset v-for="item in formList" style="margin-top: 10px"  @click="handleDetail(item)">
                      <van-cell :title="item.no" :value="item.start_user_name" :label="item.name" />
                    </van-cell-group>
                </van-list>

            </div>
        </div>
        <div v-else>
           <div>
                ${errMsg}
           </div>
        </div>
    </div>
    <script>
         const app = Vue.createApp({
             delimiters: ['${', '}'],
             data(){
                 return {
                     is_authentication:true,
                     errMsg:'',
                     tabGrid:[
                         {name:"待处理",icon:'todo-list-o'},
                         {name:"已处理",icon:'completed-o'},
                         {name:"已发起",icon:'records-o'},
                         {name:"我收到的",icon:'bookmark-o'}
                     ],
                     formList:[],
                     pageConfig:{
                       page:1,
                       limit:10,
                       is_next:false
                     },
                     loading:false,
                     finished:false,
                     tabIndex:0,
                     filterShow:false,
                     search:'',
                 }
             },
             methods:{
                 // 获取列表
                getPageList(){
                    const locat = XEUtils.locat()
                    const searchQuery = locat.searchQuery
                    const token = searchQuery.token || null
                    const domain = `${location.protocol}//${location.hostname}${location.port ? ':' : '/api'}${location.port}`;
                    axios({
                    url: `${domain}/api/dvadmin3_flow/app_flow_data/get_flow_data/`,
                    method: 'get',
                    params: {
                        handle_status:this.tabIndex,
                        page:this.pageConfig.page,
                        limit:this.pageConfig.limit,
                        search:this.search
                    },
                    headers: {
                      'Content-Type': 'application/json',
                        'Authorization': `JWT ${token}`
                    }
                  }).then(res => {
                      const {data} = res
                       if(data.code===2000){
                           if(data.page===1){
                               this.formList = data.data
                           }else{
                               this.formList = this.formList.concat(data.data)
                           }

                           if(!data.is_next){
                               this.finished = true
                           }else{
                               this.finished = false
                               this.pageConfig.page += 1
                           }
                           this.loading = false
                       }else if(data.code===401){
                           this.is_authentication = false
                           this.errMsg = "未登录,请登录授权~"
                       }else{
                           this.is_authentication = false
                           this.errMsg = data.msg
                       }
                  }).catch(err => {
                      this.is_authentication =false
                         this.errMsg = "网站错误,请联系网站管理员~"
                  })
                },
                 onSearch(){
                    this.pageConfig.page = 1
                     this.getPageList()
                 },
                 clickTab(item){
                     this.tabIndex = item.name
                     this.formList = []
                     this.pageConfig.page = 1
                     this.pageConfig.is_next = false
                      this.isLoding = true
                     this.getPageList()
                },
                 // 查看详情
                 handleDetail(item){
                     const locat = XEUtils.locat()
                      const searchQuery = locat.searchQuery
                     const token = searchQuery.token || null
                     const domain = `${location.protocol}//${location.hostname}${location.port ? ':' : '/api'}${location.port}`;
                     const flow_data_id = item.id
                     window.location.href = `${domain}/api/dvadmin3_flow/flow_data_detail_page/?token=${token}&flow_data_id=${flow_data_id}`
                 }
             },
             mounted(){

             },
         })
         app.use(vant);
         app.mount("#app");
    </script>
</body>
</html>