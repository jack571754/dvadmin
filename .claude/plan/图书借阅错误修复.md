# 图书借阅错误修复 - 执行计划

## 任务上下文

**问题描述**：图书借阅功能报错 400，前端未正确显示后端返回的错误信息

**根因分析**：
- 后端正常返回 400 状态码和具体错误信息（如"您已借阅该图书，请先归还后再借阅"）
- 前端使用 `alert()` 且错误信息提取不完整

## 执行方案

采用 **改进前端错误处理 + 使用 ElMessage 组件** 的组合方案

## 实施步骤

### ✅ 步骤 1：引入 ElMessage 组件
- 文件：`web/src/views/book/book/crud.tsx`
- 修改：添加 `import { ElMessage } from 'element-plus'`
- 状态：已完成

### ✅ 步骤 2：改进借阅按钮错误处理
- 文件：`web/src/views/book/book/crud.tsx` (第 33-50 行)
- 修改内容：
  ```typescript
  click: async ({ row }) => {
      try {
          const res = await api.borrowBook(row.id);
          if (res) {
              ElMessage.success('借阅成功');
              crudExpose.doRefresh();
          }
      } catch (error: any) {
          const errorMsg = error?.response?.data?.error ||
                          error?.response?.data?.detail ||
                          error?.message || '借阅失败';
          ElMessage.error(errorMsg);
      }
  }
  ```
- 状态：已完成

### ✅ 步骤 3：改进归还按钮错误处理
- 文件：`web/src/views/book/book/crud.tsx` (第 56-70 行)
- 修改内容：同借阅按钮逻辑
- 状态：已完成

## 测试验证

### 测试场景
1. **重复借阅**：用户已借阅某书，再次点击借阅
   - 预期：显示"您已借阅该图书，请先归还后再借阅"
2. **正常借阅**：首次借阅某书
   - 预期：显示"借阅成功"，刷新列表
3. **库存不足**：库存为 0 时借阅
   - 预期：显示"图书库存不足"
4. **归还功能**：归还已借阅的图书
   - 预期：显示"归还成功"，刷新列表

## 技术要点

### 后端返回格式（已验证）
```json
{
  "error": "您已借阅该图书，请先归还后再借阅"
}
```

### 前端错误信息提取优先级
1. `error.response.data.error` - 后端业务错误
2. `error.response.data.detail` - 详细错误信息
3. `error.message` - HTTP 错误消息
4. 默认兜底消息

## 完成时间
2026-01-27

## 执行结果
等待用户验证测试...
